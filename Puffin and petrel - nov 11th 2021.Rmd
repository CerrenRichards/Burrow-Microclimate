---
title: '"Puffin and Petrel 2021 - Nov 11th 2021"'
author: "Cerren Richards"
date: "11/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



### PUFFINS
Have to move the puffin .csv files into the working directory 

## Combine all the files

- Combine all the separate burrow .csv files

```{r}

setwd("/Users/cerren/Desktop/PhD 2021/1. Microclimate temp/2021/Temp data 2021/ATPU edited")

# Read in all the files at once
# Make a list of all the .csv files
files <- list.files(pattern="*.csv")

# First apply read.csv, then rbind
temps <- do.call(rbind, lapply(files, function(x) read.csv(x, stringsAsFactors = FALSE)))


```

## Set up the date and time correctly

```{r}
# specify the time format
library(lubridate);library(dplyr)

# Need to specify the timezone (loggers collected data in UTC)
temps$time <- as.POSIXct(temps$time, format='%Y-%m-%d %H:%M', tz = "UTC")

# Change the timezone to Newfoundland
temps$time_NL <- with_tz(temps$time, "Canada/Newfoundland")

# The loggers did not record at the same time
# Round times to the nearest 15 minutes
temps$datetime<- round_date(temps$time_NL, "15 minutes")

# Extract only the hour for making plots
temps$Time <- hour(temps$datetime) + minute(temps$datetime)/60

# Filter the data for before the loggers were placed in the burrows 
# and after they were removed
# Also for when the kestrel weather stations were placed, so everything matches up
temps <- temps %>% filter(datetime >= "2021-07-17 17:00:00") %>% 
  filter(datetime <= "2021-08-19 00:00:00")

```

## Match the logger numbers to the data

*** theres an issue with joining - more rows are added ?

Missing Outside logger - Burrow 6
Missing Inside logger - Burrows 1, 2, 3, 15, 21, 27, 29

```{r}
setwd("/Users/cerren/Desktop/PhD 2021/1. Microclimate temp/Data/2021 Data/Temp data 2021")

loggers <- read.csv("Burrow_Logger.csv")

library(dplyr)

temps <- left_join(temps, loggers, by = "ID")

## save the formatted file
write.csv(temps, "ATPU_formatted_temps.csv")
```


# PETREL DATA

```{r}
setwd("/Users/cerren/Desktop/PhD 2021/1. Microclimate temp/2021/Temp data 2021/LSSP edited")

files <- list.files(pattern="*.csv")

# First apply read.csv, then rbind
temps_LSSP <- do.call(rbind, lapply(files, function(x) read.csv(x, stringsAsFactors = FALSE)))


```

## Set up the date and time correctly

```{r}
# specify the time format
library(lubridate); library(dplyr)

# Need to specify the timezone (loggers collected data in UTC)
temps_LSSP$time <- as.POSIXct(temps_LSSP$time, format='%Y-%m-%d %H:%M', tz = "UTC")

# Change the timezone to Newfoundland
temps_LSSP$time_NL <- with_tz(temps_LSSP$time, "Canada/Newfoundland")

# The loggers did not record at the same time
# Round times to the nearest 15 minutes
temps_LSSP$datetime<- round_date(temps_LSSP$time_NL, "15 minutes")

# Extract only the hour for making plots
temps_LSSP$Time <- hour(temps_LSSP$datetime) + minute(temps_LSSP$datetime)/60

# Filter the data for before the loggers were placed in the burrows 
# and after they were removed
temps_LSSP <- temps_LSSP %>% filter(datetime >= "2021-08-10 18:00:00") %>% 
  filter(datetime <= "2021-09-25 00:00:00")

# join the plot type data
plotdat <- read.csv("plotdata2021.csv")
loggers <- left_join(loggers, plotdat)

#join logger data
temps_LSSP <- left_join(temps_LSSP, loggers, by = "ID")


# Save the formatted data
write.csv(temps_LSSP, "petrel_temps_formatted.csv")

```

## Join the formatted ATPU and LSSP data

```{r}
## For reading in the data if the above steps have already been done:
setwd("/Users/cerren/Desktop/PhD 2021/1. Microclimate temp/Data/2021 Data/Temp data 2021")
temps <- read.csv('ATPU_formatted_temps.csv')
temps_LSSP <- read.csv('petrel_temps_formatted.csv')
temps <- temps %>% filter(datetime >= "2021-07-17 17:00:00")


## join the puffin and petrel data
ATPU_LSSP <- rbind(temps, temps_LSSP)

# specify the order of the colours
ATPU_LSSP$Location <- factor(ATPU_LSSP$Location, levels=c("Outside", "Inside"))

# replace species abbreviations for full names
ATPU_LSSP$Species[ATPU_LSSP$Species == "ATPU"] <- "Atlantic puffin"
ATPU_LSSP$Species[ATPU_LSSP$Species == "LSSP"] <- "Leach's storm-petrel"

# If loading the data in as the formatted files, will need to reset the datetime as posixct
ATPU_LSSP$datetime <- as.POSIXct(ATPU_LSSP$datetime, format='%Y-%m-%d %H:%M')

# add the date
ATPU_LSSP$Date <- as.Date(ATPU_LSSP$datetime)

```

## Join the burrow features to the dataframe of temperatures

```{r}
library(tidyr);library(dplyr)

setwd('/Users/cerren/Desktop/PhD 2021/1. Microclimate temp/Data/2021 Data')

# read in the burrow data
burrows <- read.csv("burrow_features.csv")

# replace species abbreviations for full names
burrows$Species[burrows$Species == "ATPU"] <- "Atlantic puffin"
burrows$Species[burrows$Species == "LSSP"] <- "Leach's storm-petrel"

# Create the dataframe for modelling and further analyses
# Spread the dataframe so that there is an individual 
# column for internal and external temperatures
model_df<- ATPU_LSSP %>% 
  select(datetime, Date, Time, Species, Burrow, Location, Plot, temp) %>% 
  spread(key = Location, value = temp)

# Select the columns that we want to join to the model_df
burrows <- burrows %>% select(Species, Burrow, Elevation:Proportion_fern)

# Join the burrow feature data to the model_df dataframe
model_df <- left_join(model_df, burrows)

# The following burrows lost loggers, so we will remove them from the dataframe
# Missing Outside logger - Burrow 6
# Missing Inside logger - Burrows 1, 2, 3, 15, 21, 27, 29
# Internal logger from burrow 9 was found on the ground outside the burrow -
# We will therefore exclude burrow 9 data also 
model_df <- model_df %>% 
  filter(!Burrow %in% c(1, 2, 3, 9, 15, 21, 27, 29))

## **************************
## NOTE: Burrow 36 is missing a width - because it had two burrow entrances
## NOTE: Burrow 6 does not have external logger data
## **************************


```


## WEATHER DATA

Format the weather data

```{r}

setwd("/Users/cerren/Desktop/PhD 2021/1. Microclimate temp/Data/2021 Data/Weather Data 2021/Edited")

# Read in the weather data from the two kestrel weather meters
weather1 <- read.csv("WEATHER_kestrel2581085.csv")
weather2 <- read.csv("WEATHER_kestrel2581086.csv")


# Substitute the "p.m." and "a.m." because there are issues when converting 12hrs to 24hrs
weather1$datetime <- gsub("p.m.", "pm", weather1$datetime)
weather1$datetime <- gsub("a.m.", "am", weather1$datetime)

weather2$datetime <- gsub("p.m.", "pm", weather2$datetime)
weather2$datetime <- gsub("a.m.", "am", weather2$datetime)

# Convert the time from 12 hrs to 24 hrs
weather1$datetime <- as.POSIXct(weather1$datetime, format="%Y-%m-%d %I:%M:%S %p")
weather2$datetime <- as.POSIXct(weather2$datetime, format="%Y-%m-%d %I:%M:%S %p")

library(dplyr);library(lubridate)
# Filter the data for the correct date range
weather1 <- weather1 %>% filter(datetime <= "2021-09-25 00:00:00")
weather2 <- weather2 %>% filter(datetime <= "2021-09-25 00:00:00")

# Extract only the hour for making plots
weather1$Time <- hour(weather1$datetime) + minute(weather1$datetime)/60
weather2$Time <- hour(weather2$datetime) + minute(weather2$datetime)/60

# Add a single date column
weather1$Date <- as.Date(weather1$datetime)
weather2$Date <- as.Date(weather2$datetime)

# Assign station name
weather1$Station <- "Forested Plot"
weather2$Station <- "Open Plot"

# Join the two weather dataframes
weather <- rbind(weather1, weather2)

```

## Join the weather data to the model_df

weather1 = "Forested Plot"
weather2 = "Open Plot"

The kestrel weather stations were placed in different plots, so we need to make sure the correct weather data is matched up to the logger data

```{r}

# Subset the logger data by the plot type that match the kestrel weather station data
open <- model_df %>% filter(Plot %in% c("Slope", "Open"))
forest <- model_df %>% filter(Plot %in% c("Forest", "Near Forest"))

# Join the kestrel weather data and the temp logger data
forest_join <- left_join(forest, weather1)
open_join <- left_join(open, weather2)

# join the data back together again
model_df_long <- rbind(forest_join, open_join)

# kestrel weather data were only recorded every 30 minutes 
# while logger data were every 15 minutes
# we will filter the logger data so it matches the kestrel data
model_df_short <- model_df_long %>% filter(!is.na(Temperature))


```


## Explore the buffering

negative = inside colder than outside
positive = warmer than outside

outlogger is warmer or colder than the kestrel
```{r}

## How do the external loggers compare to the kestrel weather station
# Positive = logger is warmer than kestrel
# Negative = logger is colder than kestrel
model_df_short$diff <- model_df_short$Outside - model_df_short$Temperature

# Plot the difference
ggplot(data = model_df_short, aes(x = datetime, y = diff, group = Burrow))+
  geom_line(aes(colour = Burrow))+
  plottheme+
  theme(legend.title = element_blank())+ 
  xlab("Date") + ylab("Temperature difference (°C)")+
  #scale_color_viridis(discrete = TRUE, alpha = 0.5)+
  theme(legend.position = "none")+
  facet_wrap(~Species, scales = "free_x")+
  theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"), 
        strip.background = element_rect(fill="black"),
        axis.title.x = element_blank())


# Calculate the buffering capacity of the burrows
# Positive – burrow is warmer than external
# Negative – burrow is cooler than external

# Logger buffer
model_df_short$buffer_logger <- model_df_short$Inside - model_df_short$Outside

# kestrel buffer
model_df_short$buffer_kestrel <- model_df_short$Inside - model_df_short$Temperature


## Calculate the elliptical cylinder volume of the burrow for the modelling
model_df_short$volume <- pi * (model_df_short$Width/2) * (model_df_short$Height/2) * model_df_short$Depth

## Visualise the difference in burrow volume between species
ggplot(data = model_df_short, aes(x = Species, y = volume))+
  geom_boxplot()+
  plottheme


## Save the file for modelling
write.csv(model_df_short, "model_df_short.csv")
model_df_short <- read.csv("model_df_short.csv")

model_df_short$Date <- as.Date(model_df_short$Date)

## Set the date as Julian Days
# model_df_short$Date <- as.Date(model_df_short$Date)
model_df_short$julian <- format(model_df_short$Date, "%j")

# Julian date is currently categorical. We will set as numeric
model_df_short$julian <- as.numeric(model_df_short$julian)

library(dplyr)

# Filter the dataframe for the different species
# because separate models will be run for the species
lssp <- filter(model_df_short, Species == "Leach's storm-petrel")
atpu <- filter(model_df_short, Species == "Atlantic puffin")

# set burrow as factor
lssp$Burrow <- factor(lssp$Burrow)

# save a file so if it crashes
#save(lssp, file = "lssp.Rdata")

# load in
load("lssp.Rdata")


# Explore the data
hist(lssp$buffer_logger)
hist(atpu$buffer_logger)

hist(lssp$buffer_kestrel)
hist(atpu$buffer_kestrel)

hist(lssp$Outside)
hist(atpu$Outside)

hist(lssp$Inside)
hist(atpu$Inside)

hist(lssp$Temperature)
hist(atpu$Temperature)

hist(weather$Temperature)

library(mgcv)


m1 <- gamm(data = lssp,
           buffer_kestrel~s(Enterance_Area) + s(Height) + s(Width) + s(Depth),
           random = list(Burrow = ~1))

m1 <- gamm(data = lssp,
           buffer_kestrel~s(Enterance_Area) + s(volume),
           random = list(Burrow = ~1))

m2 <- gamm(data = model_df_short,
           buffer_kestrel~s(Enterance_Area) + s(volume),
           random = list(Burrow = ~1))


m3 <- gamm(data = atpu,
           Inside~s(Temperature)+ s(Enterance_Area) + s(volume) +s(Time),
           random = list(Burrow = ~1))

hist(resid(m3$gam))
plot(m3$gam)

summary(m3$gam)


ggplot(data = model_df_short, aes(x = Plot, y = Inside))+
  geom_boxplot()+
  plottheme


plot(lssp$Canopy,    lssp$buffer_logger)
plot(lssp$Ground_cover,    lssp$buffer_kestrel)
plot(lssp$Proportion_fern, lssp$buffer_logger)

plot(atpu$Wind.Speed, atpu$Inside)

plot(lssp$Barometric.Pressure, lssp$Temperature)

plot(model_df_short$volume, model_df_short$Inside)

plot(model_df_short$Enterance_Area, model_df_short$buffer_kestrel)



## Build first model
## PREDICTORS OF BURROW MICROCLIMATE
library(mgcv)

# Petrel


# no need for gamm - can model with gam and include random effects like `s(Burrow, bs="re")`, where bs="re" indicates random effects

# For the time spline, it's important to define it as circular with bs="cc"

# When we were building the models, we we're individually removing the spline predictors, but using bs="ts", removes them for you within the model for you

# We scaled the predictors in the model, but scaling them in the dataframe lets you compare whats happening to the raw data when you're scaling (it's fine to do either way though)

# It's better to use method = REML, rather than the GCV default

# You can run gam in parallel with gam control to make it go faster when you have lots of data 

# The default number for k is 10, so in the model summary, when the edf is 9, it's recommended to double the k value. There are lots of methods to test for whether you need to change the k values. 

# Post gam checks:
# Dharma package for checking the model fit

# pre gam checks:
# vis.concurvity function in the dsm package (darker colours = bad) - like a multicolinearity check, but for squiggliness 


m14 <- gam(data = lssp,
           Inside~s(scale(Temperature), bs="ts") + s(scale(Wind.Speed),bs="ts") +  # Environment
                  s(scale(Enterance_Area),bs="ts") + s(scale(volume),bs="ts") + # Burrow features
                  s(scale(Canopy), bs="ts") + s(scale(Ground_cover), bs="ts") + # Habitat
                  s(scale(Time), bs="cc") + s(scale(julian), bs="ts")+ # Time and date
                  s(Burrow, bs="re"), # random effect
                  method = "REML") 

summary(m14)

### LEFT HERE APRIL 11TH, 2O22 

# "ts" removes it from the model - like removing it from the model
# time - important to define circular 
# "day of year" not Julian
# ?choose.k for info
# use REML rather than the GCV default
# when edf is 9, recommended to double the K
# p-val test to see whether to change to k values

# gam control - parallel
# GLMM faq - Ben Bolker
# GLM - standard error that are too wide if overfitting
# check out about overfitting
# post gam checks 
# vif
# model without the scale
# Dharma
# concurvity - mgcv library - 3 values - use the middle
# vis.concurvity - dsm package - dark = bad






m1 <- gamm(data = lssp,
           Inside~s(scale(Temperature)) + s(scale(Wind.Speed)) +  # Environment
                  s(scale(Enterance_Area)) + s(scale(volume)) + # Burrow features
                  s(scale(Canopy)) + s(scale(Ground_cover)) + # Habitat
                  s(scale(Time)) + s(scale(julian)), # Time and date
           random = list(Burrow = ~1))




m10 <- gamm(data = lssp,
           Inside~s(scale(Temperature)) + s(scale(Wind.Speed)) +  # Environment
                  s(scale(Time)) + s(scale(julian)), # Time and date
           random = list(Burrow = ~1))


m11 <- gamm(data = lssp,
           Inside~scale(Temperature) +
                  s(scale(Time)) + s(scale(julian)), # Time and date
           random = list(Burrow = ~1))


m12 <- gamm(data = lssp,
           Inside~s(scale(Time)) + s(scale(julian)), # Time and date
           random = list(Burrow = ~1))


# take resid of m12 - which are under or over preforming relative to time and date
#avg burrow response and which are deviating 

# Look at the residuals 
lssp$residuals_lssp <- resid(m12$gam)

# Make burrow a character
lssp$ID <- as.character(lssp$Burrow)

# Visualise the residuals between burrows
library(ggplot2)
ggplot(data = lssp, aes(x = ID, y = residuals))+
  geom_boxplot()+
  plottheme

# Residual model
m13 <- gamm(data = lssp,
           residuals_lssp~s(scale(Temperature)) + s(scale(Wind.Speed))+ # Environment
                   s(scale(Enterance_Area)) + s(scale(Height)) + # Burrow features
                  s(scale(Canopy)) + s(scale(Ground_cover)), # Habitat 
           random = list(Burrow = ~1))




plot(lssp$Enterance_Area, lssp$residuals_lssp)
plot(lssp$Height, lssp$residuals_lssp)
plot(lssp$Width, lssp$residuals_lssp)
plot(lssp$Depth, lssp$residuals_lssp)
plot(lssp$volume, lssp$residuals_lssp)
plot(lssp$Ground_cover, lssp$residuals_lssp)
plot(lssp$Canopy, lssp$residuals_lssp)
plot(lssp$Temperature, lssp$residuals_lssp)
plot(lssp$Wind.Speed, lssp$residuals_lssp)



summary(m11$gam)
summary(m12$gam)

plot(m10$gam)

#r2 - the most predictive model - how much variance is explained 

# what's different with the outliers? what's unique 

m8 <- gam(data = mean,
           mean_inside~ # Environment
                  s(scale(Enterance_Area), k=4) + s(scale(volume), k=4) +
            s(scale(Width), k=4) + s(scale(Height), k=4)+ s(scale(Depth), k=4)+# Burrow features
                  s(scale(Canopy), k=4) + s(scale(Ground_cover), k=4 ))

m9 <- gam(data = mean,
           mean_inside~ # Environment
                  s(scale(Canopy), k=4) + s(scale(Ground_cover), k=4 ))

plot(m9)

# depth important
# Expand out the column heading 
# intercept for each burrow

#average temp for each burrow 

mean <- lssp %>% group_by(Burrow) %>% summarise(mean_temp = mean(Temperature),
                                                mean_out = mean(Outside),
                                        mean_wind = mean(Wind.Speed),
                                        mean_inside= mean(Inside))

mean <- left_join(mean, burrows)

mean <- filter(mean, Species == "LSSP" )

hist(resid(m1$gam))
plot(m1$gam)
summary(m1$gam)

plot(lssp$Temperature, lssp$Date)





## PREDICTORS OF BURROW BUFFERING CAPACITY

# Petrel (WEATHER STATION BUFFER)
m3 <- gamm(data = lssp,
           buffer_kestrel~ s(Wind.Speed) +  # Environment
                  s(Enterance_Area) + s(volume) + # Burrow features
                  s(Canopy) + s(Ground_cover) + # Habitat
                  s(Time) + s(julian), # Time and date
           random = list(Burrow = ~1))

hist(resid(m3$gam))
plot(m3$gam)
summary(m3$gam)











## Puffin 
m2 <- gamm(data = atpu,
           Inside~s(Temperature) + s(Wind.Speed) +  # Environment
                  s(Enterance_Area) + s(volume) + # Burrow features
                  s(Time) + s(julian), # Time and date
           random = list(Burrow = ~1))

hist(resid(m2$gam))
plot(m2$gam)
summary(m2$gam)






# Petrel (LOGGER BUFFER)
m4 <- gamm(data = lssp,
           buffer_logger~s(Temperature) + s(Wind.Speed) +  # Environment
                  s(Enterance_Area) + s(volume) + # Burrow features
                  s(Canopy) + s(Ground_cover) + # Habitat
                  s(Time) + s(julian), # Time and date
           random = list(Burrow = ~1))

hist(resid(m4$gam))
plot(m4$gam)
summary(m4$gam)



# Puffin (WEATHER STATION BUFFER)
m5 <- gamm(data = atpu,
           buffer_kestrel~ s(Wind.Speed) +  # Environment
                  s(Enterance_Area) + s(volume) + # Burrow features
                  s(Time) + s(julian), # Time and date
           random = list(Burrow = ~1))

hist(resid(m5$gam))
plot(m5$gam)
summary(m5$gam)


# Petrel (LOGGER BUFFER)
m6 <- gamm(data = atpu,
           buffer_logger~s(Temperature) + s(Wind.Speed) +  # Environment
                  s(Enterance_Area) + s(volume) + # Burrow features
                  s(Time) + s(julian), # Time and date
           random = list(Burrow = ~1))

hist(resid(m6$gam))
plot(m6$gam)
summary(m6$gam)




m7 <- gamm(data = lssp,
           Inside~s(Temperature) + s(Wind.Speed) +  # Environment
                  s(Enterance_Area) + s(Height) + s(Width) + s(Depth)+ # Burrow features
                  s(Canopy) + s(Ground_cover) + # Habitat
                  s(Time) + s(julian), # Time and date
           random = list(Burrow = ~1))


hist(resid(m7$gam))
plot(m7$gam)
summary(m7$gam)



## Interaction between canopy cover and total ground cover?
## Add the logger depth as a random effect?
## Height, Width, Depth or just Volume?



# directly compare effect size by scaling

# do any of the burrows respond differently during the extreme events - was there anything different in the features for those burrows?

#bs=cc


```





## MODELLING

Eight modelling steps from Zurr et al. (2010) "A protocol for data exploration to avoid common statistical problems":

1. Are there outliers in Y and X?
2. Do we have homogeneity of variance?
3. Are the data normally distributed?
4. Are there lots of zeros in the data?
5. Is there collinearity among the covariates?
6. What are the relationships between Y and X variables?
7. Should we consider interactions?
8. Are observations of the response variable independent?



# Look for multicolinearity 

library(GGally)

ggpairs(filter(model_df_short, Species == "Atlantic puffin"), 
        columns = c(7,8,9,12:18, 21, 24)) 

ggpairs(filter(model_df_short, Species == "Leach's storm-petrel"), 
        columns = c(7,8,9,12,13)) 


pairs(model_df_short[,c(7,8,9,12:18, 21, 24)], pch = 19, lower.panel = NULL)

library(psych)
pairs.panels(model_df_short[,c(7,8,9,12:18, 21, 24)],
             method = "pearson")

```{r}

## Predict drivers of burrow microclimate
## PETREL

# Build initial model
m14 <- gam(data = lssp,
           Inside~s(scale(Temperature), bs="ts") + s(scale(Wind.Speed),bs="ts") +  # Environment
                  s(scale(Enterance_Area),bs="ts") + s(scale(volume),bs="ts") + # Burrow features
                  s(scale(Canopy), bs="ts") + s(scale(Ground_cover), bs="ts") + # Habitat
                  s(scale(Time), bs="cc") + s(scale(julian), bs="ts")+ # Time and date
                  s(Burrow, bs="re"), # random effect
                  method = "REML") 


# Visualise concurvity of the model
library(dsm)
vis.concurvity(m14)

# Explore model fit with `DHARMa` package
# https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html
library(DHARMa); library(lme4); library(mgcViz)

# Visualise dispersion
testDispersion(m14)

# QQplot
plotQQunif(m14)

# Residuals
plotResiduals(m14)

# Test for zero inflation
testZeroInflation(m14)

hist(resid(m14))
plot(m14)

summary(m14) # edf is close to 9 for temperature and julian date, so we will double the knots to 20

m15 <- gam(data = lssp,
           Inside~s(scale(Temperature), bs="ts", k = 20) + s(scale(Wind.Speed),bs="ts") +  # Environment
                  s(scale(Enterance_Area),bs="ts") + s(scale(volume),bs="ts") + # Burrow features
                  s(scale(Canopy), bs="ts") + s(scale(Ground_cover), bs="ts") + # Habitat
                  s(scale(Time), bs="cc") + s(scale(julian), bs="ts", k = 20)+ # Time and date
                  s(Burrow, bs="re"), # random effect
                  method = "REML") 

# Model checks
AIC(m14, m15) # m15 reduces the AIC 
testDispersion(m15)
plotQQunif(m15)
plotResiduals(m15)
testZeroInflation(m15)
hist(resid(m15))
plot(m15)



## Predict drivers of burrow microclimate
## PUFFIN

m1_puffin <- gam(data = atpu,
             Inside~s(scale(Temperature), bs="ts") + s(scale(Wind.Speed),bs="ts") +  # Environment
                  s(scale(Enterance_Area),bs="ts") + s(scale(volume),bs="ts") + # Burrow features
                  s(scale(Time), bs="cc") + s(scale(julian), bs="ts")+ # Time and date
                  s(Burrow, bs="re"), # random effect
                  method = "REML") 

# Model checks
vis.concurvity(m1_puffin)
plotQQunif(m1_puffin)
plotResiduals(m1_puffin)
testDispersion(m1_puffin)
testZeroInflation(m1_puffin)
hist(resid(m1_puffin))
plot(m1_puffin)
summary(m1_puffin)

# edf is close to 9 for temperature, entrance area, volume and julian date, so we will double the knots to 20
m2_puffin <- gam(data = atpu,
             Inside~s(scale(Temperature), bs="ts", k = 20) + # Environment
                  s(scale(Wind.Speed),bs="ts") +  # Environment
                  s(scale(Enterance_Area),bs="ts", k = 20) + # Burrow features
                  s(scale(volume),bs="ts", k = 20) + # Burrow features
                  s(scale(Time), bs="cc") + s(scale(julian), bs="ts", k = 20)+ # Time and date
                  s(Burrow, bs="re"), # random effect
                  method = "REML") 


AIC(m1_puffin, m2_puffin) # m2 reduces the AIC
vis.concurvity(m2_puffin)
plot(m2_puffin)
summary(m2_puffin)

```







## Create seasonal temperature trend plot

```{r}

library(ggplot2);library(patchwork);library(viridis)

# Summarise the mean temperature and standard deviation for inside and outside the burrows
season_mean_temp <- ATPU_LSSP %>%
  group_by(Species, Location, datetime, Date, Time) %>%
  summarise(mean = mean(temp), sd = sd(temp),
            n = n(), se = sd/sqrt(n))


## Set the theme
plottheme <-  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  theme(axis.title.y = element_text(vjust = 3)) +
  theme(axis.title.x = element_text(vjust = -1))


## _____________ INDIVIDUAL PLOTS _____________

# Temp trend Plot
tempall <- ggplot(data = season_mean_temp, aes(x = datetime, y = mean, group = Location))+
  geom_line(aes(colour = Location, linetype = Location))+
  geom_ribbon(aes(ymin=mean-sd, ymax=mean+sd, fill = Location), alpha = 0.4)+
  plottheme+
  theme(legend.title = element_blank())+ 
  xlab("Date") + ylab("Temperature (°C)")+
  scale_colour_manual(values = c("#43A407", "#4E342E"))+
  scale_fill_manual(values = c("#43A407", "#4E342E"))+
  theme(legend.position = c(0.85, 0.70))+
  facet_wrap(~Species, scales = "free_x")+
  theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"), 
        strip.background = element_rect(fill="black"),
        axis.title.x = element_blank())


# Tile plot
ggplot(filter(season_mean_temp, Location == "Inside"), 
               aes(x = Date, y = Time, fill = mean)) +
  geom_tile(colour = "white", size = 0.15)+
  plottheme+
  scale_fill_distiller(palette = "RdYlBu", direction = -1)+
  ylab("Time of Day (h)")+ theme(axis.title.y = element_text(vjust = 3)) +
  theme(legend.position="bottom")+
  guides(fill = guide_colourbar(barwidth = 10, barheight = 0.5))+
  facet_wrap(~Species, scales = "free")+
    theme(strip.text.x = element_text(size = 16, color = "white"), 
        strip.background = element_rect(fill="black"))



## _____________ COMBINED PLOTS _____________


# Temp trend Plot
temp <- ggplot(data = season_mean_temp, aes(x = datetime, y = mean, group = Location))+
  geom_line(aes(colour = Location, linetype = Location))+
  geom_ribbon(aes(ymin=mean-sd, ymax=mean+sd, fill = Location), alpha = 0.4)+
  plottheme+
  theme(legend.title = element_blank())+ 
  xlab("Date") + ylab("Temperature (°C)")+
  scale_colour_manual(values = c("#43A407", "#4E342E"))+
  scale_fill_manual(values = c("#43A407", "#4E342E"))+
  theme(legend.position = c(0.85, 0.80))+
  facet_wrap(~Species, scales = "free_x")+
  theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"), 
        strip.background = element_rect(fill="black"))+
      theme(axis.title.x = element_blank(),
        axis.text.x =element_blank(),
        axis.ticks.x=element_blank())


# Tile plot
heat <- ggplot(filter(season_mean_temp, Location == "Inside"), 
               aes(x = Date, y = Time, fill = mean)) +
  geom_tile(colour = "white", size = 0.15)+
  plottheme+
  scale_fill_distiller(palette = "RdYlBu", direction = -1)+
  ylab("Time of Day (h)")+ theme(axis.title.y = element_text(vjust = 3)) +
  theme(legend.position="blank")+
  guides(fill = guide_colourbar(barwidth = 10, barheight = 0.5))+
  facet_wrap(~Species, scales = "free_x")+
    theme(strip.text.x = element_blank(), 
          strip.background = element_blank())


# Create the combined plot
temp / heat


ATPU_LSSP$Burrow <- as.character(ATPU_LSSP$Burrow)

## plot of individual burrow variation
ggplot(data = filter(ATPU_LSSP, Location =="Inside"), aes(x = datetime, y = temp, group = Burrow))+
  geom_line(aes(colour = Burrow))+
  #geom_ribbon(aes(ymin=mean-sd, ymax=mean+sd, fill = Location), alpha = 0.4)+
  plottheme+
  theme(legend.title = element_blank())+ 
  xlab("Date") + ylab("Temperature (°C)")+
  #scale_colour_brewer(palette = "YlGnBu")+
  scale_color_viridis(discrete = TRUE, alpha = 0.5)+
  #scale_fill_manual(values = c("#43A407", "#4E342E"))+
  theme(legend.position = "none")+
  facet_wrap(~Species, scales = "free_x")+
  theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"), 
        strip.background = element_rect(fill="black"),
        axis.title.x = element_blank())


```

## Hour of day average

```{r}

# Summarise the mean temperature and standard deviation for inside and outside the burrows
mean_temp <- ATPU_LSSP %>%
  group_by(Location, Time, Species) %>%
  summarise(mean = mean(temp), sd = sd(temp),
            n = n(), se = sd/sqrt(n))


## With all axes
# temperature trend line
ggplot(data = mean_temp, aes(x = Time, y = mean, group = Location))+
  geom_line(aes(colour = Location, linetype = Location))+
  geom_ribbon(aes(ymin=mean-sd, ymax=mean+sd, fill = Location), alpha = 0.35)+
  xlab("Time of Day (h)") + ylab("Temperature (°C)")+
  scale_x_continuous(breaks=seq(0,23,4))+
  plottheme+
  theme(legend.title = element_blank())+ 
  scale_colour_manual(values = c("#43A407", "#4E342E"))+
  scale_fill_manual(values = c("#43A407", "#4E342E"))+
  theme(legend.position = c(0.9, 0.8))+
  facet_wrap(~Species, scales = "free_x")+
  theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"), 
        strip.background = element_rect(fill="black"))



## Without x-axes for creating the patchwork plot below
# temperature trend line
logger_plot <- ggplot(data = mean_temp, aes(x = Time, y = mean, group = Location))+
  geom_line(aes(colour = Location, linetype = Location), size = 1.25)+
  geom_ribbon(aes(ymin=mean-sd, ymax=mean+sd, fill = Location), alpha = 0.35)+
  ylab("Temperature (°C)")+
  scale_x_continuous(breaks=seq(0,23,4))+
  plottheme+
  theme(legend.title = element_blank())+ 
  scale_colour_manual(values = c("#43A407", "#4E342E"))+
  scale_fill_manual(values = c("#43A407", "#4E342E"))+
  theme(legend.position = c(0.9, 0.8))+
   theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank())+
  facet_wrap(~Species, scales = "free_x")+
  theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"), 
        strip.background = element_rect(fill="black"))





## Create a second plot with the kestrel weather data 

# Summarise the weather data
weather_sum <- weather %>% group_by(Time) %>%
    summarise(mean = mean(Temperature), sd = sd(Temperature),
            n = n(), se = sd/sqrt(n))


#gather the data 
maxmin_season <- model_df_short %>% select(Date, Time, 
                                           Species, Outside, 
                                           Inside, Temperature) %>%
  gather(Location, Temp, Outside:Temperature)

# Give the kestrel data a new name
maxmin_season$Location[maxmin_season$Location == "Temperature"] <- "Air"

# Burrow 6 is missing
maxmin_season <- maxmin_season %>% group_by(Time, Species, Location) %>%
    summarise(Mean = mean(Temp, na.rm = T),
            Max = max(Temp, na.rm = T), 
            Min = min(Temp, na.rm = T),
             sd = sd(Temp, na.rm = T))

# specify the order of the colours
maxmin_season$Location <- factor(maxmin_season$Location, levels=c("Outside", "Air", "Inside"))



kestrel_plot<- ggplot(data = filter(maxmin_season, Location %in% c("Air", "Inside")), 
       aes(x = Time, y = Mean, group = Location))+
  geom_line(aes(colour = Location, linetype = Location), size = 1.25)+
  geom_ribbon(aes(ymin=Mean-sd, ymax=Mean+sd, fill = Location), alpha = 0.35)+
  xlab("Time of Day (h)") + ylab("Temperature (°C)")+
  scale_x_continuous(breaks=seq(0,23,4))+
  plottheme+
  theme(legend.title = element_blank())+ 
  scale_colour_manual(values = c( "#80DEEA","#4E342E"))+
  scale_fill_manual(values = c("#80DEEA","#4E342E"))+
  theme(legend.position = "blank")+
  facet_wrap(~Species, scales = "free_x")+
  theme(strip.text.x = element_blank(), 
        strip.background = element_blank())


library(patchwork)

logger_plot / kestrel_plot

ggsave("avg_temp_plot.png", 
       width = 200, height = 170, unit = "mm")



## ****** THIS IS THE FINAL PLOT ******
ggplot(data = maxmin_season, aes(x = Time, y = Mean, group = Location))+
  geom_ribbon(aes(ymin=Mean-sd, ymax=Mean+sd, fill = Location), alpha = 0.35)+
  geom_line(aes(colour = Location, linetype = Location),  size = 1.25)+
  xlab("Time of Day (h)") + ylab("Temperature (°C)")+
  scale_x_continuous(breaks=seq(0,23,4))+
  plottheme+
  theme(legend.title = element_blank())+ 
  scale_colour_manual(values = c("#43A407","#80DEEA", "#4E342E"))+
  scale_fill_manual(values = c("#43A407","#80DEEA", "#4E342E"))+
  theme(legend.position = c(0.9, 0.8))+
  facet_wrap(~Species, scales = "free_x")+
  theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"), 
        strip.background = element_rect(fill="black"))

ggsave("avg_temp_plot_legend.png", 
       width = 170, height = 100, unit = "mm")


# Max/min plot 
ggplot()+
  geom_ribbon(data = maxmin_season, aes(x = Time, y = Min, ymin=Min, ymax=Max, fill = Location, linetype = Location), alpha = 0.35)+
    geom_line(data = maxmin_season, aes(x = Time, y = Mean, 
                                    group = Location, 
                                    linetype = Location, 
                                    colour = Location),
              size = 1.5)+
  xlab("Time of Day (h)") + ylab("Temperature (°C)")+
  scale_x_continuous(breaks=seq(0,23,4))+
  plottheme+
  theme(legend.title = element_blank())+ 
  scale_colour_manual(values = c("#E0DEBF",   "#43A407","#4E342E"))+
  scale_fill_manual(values = c("#E0DEBF",   "#43A407","#4E342E"))+
  theme(legend.position = c(0.9, 0.9))+
  facet_wrap(~Species, scales = "free_x")+
  theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"), 
        strip.background = element_rect(fill="black"))

```

## Max, min, mean -  updated plot - THIS

```{r}

library(tidyr)

## Daily max, min and mean - no gray lines

## Summarise the daily max, min and mean for each burrow
maxmin <- ATPU_LSSP %>% filter(Location == "Inside") %>%
  group_by(Date, Burrow, Species) %>%
  summarise(`Daily Mean` = mean(temp),
            `Daily Max.` = max(temp), 
            `Daily Min.` = min(temp))

# Gather the data
maxmin2 <- maxmin %>% gather(Unit, Temperature, `Daily Mean`:`Daily Min.`)
maxmin2$Burrow <- as.character(maxmin2$Burrow)


## Daily max, min and mean - with gray lines
ATPUmaxmin <- maxmin2 %>% filter(Species == "Atlantic puffin")
LSSPmaxmin <- maxmin2 %>% filter(Species == "Leach's storm-petrel")

## Plot a facet wrap version

# Calculate the mean line
meanline <- maxmin2 %>% group_by(Species, Unit) %>%
  summarise(mean = mean(Temperature))
  

# Create an overall max, min, mean boxplot for all burrows
box_mmmm <- ggplot()+
  geom_boxplot(data = maxmin2, aes(x = Unit, 
                  y = Temperature, 
                  fill = Unit))+
    scale_fill_manual(values = c("#E16E08", "#F9E07F","#89B4C7")) +
    plottheme+
    guides(alpha = FALSE, fill = FALSE, colour = FALSE)+
   ylab("Temperature (°C)")+
  facet_wrap(~Species, ncol = 1, scales = "free")+
    theme(strip.background = element_blank(),
  strip.text.x = element_blank())+
  theme(axis.title.x = element_blank())

## Summarise the mean daily temperatures across all burrows so that we can order
## the main plot by decreaing mean temp
mean <- filter(maxmin2, Unit =="Daily Mean") %>% group_by(Species, Burrow) %>% 
  summarise(mean = mean(Temperature))

## Match to the means to the maxmin2 dataframe
maxmin2 <- left_join(maxmin2, mean)

## Filter the data for the two species for the analyses below
ATPU <- maxmin2 %>% filter(Species == "Atlantic puffin")
LSSP <- maxmin2 %>% filter(Species == "Leach's storm-petrel")


# Create the between burrow variation violin plot
## Atlantic puffins
violin_ATPU<- ggplot()+
  geom_violin(data = ATPU, 
              aes(x = reorder(Burrow, -mean), 
                  y = Temperature, 
                  fill = Unit, colour = Unit))+
  scale_fill_manual(values = c("#E16E08", "#F9E07F","#89B4C7")) +
  scale_colour_manual(values = c( "#E16E08","#F9E07F","#89B4C7")) +
  ylab("Temperature (°C)")+
  plottheme+
  guides(alpha = FALSE, fill = FALSE, colour = FALSE)+
  facet_grid(Unit ~.)+
  theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"),
        strip.text.y = element_text(size = 16, color = "white", face = "bold"),
        strip.background = element_rect(fill="black"))+
  geom_hline(data = filter(meanline,Species == "Atlantic puffin"), aes(yintercept = mean), linetype = "dashed")+
  theme(axis.title.x = element_blank(),
        axis.text.x=element_blank())


## Leach's storm-petrels
violing_LSSP<- ggplot()+
  geom_violin(data = LSSP, 
              aes(x = reorder(Burrow, -mean), 
                  y = Temperature, 
                  fill = Unit, colour = Unit))+
  scale_fill_manual(values = c("#E16E08", "#F9E07F","#89B4C7")) +
  scale_colour_manual(values = c( "#E16E08","#F9E07F","#89B4C7")) +
  xlab("Burrow ID") + ylab("Temperature (°C)")+
  plottheme+
  guides(alpha = FALSE, fill = FALSE, colour = FALSE)+
  facet_grid(Unit ~.)+
  theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"),
        strip.text.y = element_text(size = 16, color = "white", face = "bold"),
        strip.background = element_rect(fill="black"))+
  geom_hline(data = filter(meanline,Species == "Leach's storm-petrel"), aes(yintercept = mean), linetype = "dashed")+
   theme(axis.title.x = element_blank(),
        axis.text.x=element_blank())



## Combine the plots
library(patchwork)
box_mmmm + (violin_ATPU / violing_LSSP) + plot_layout(widths=c(1,2))

## Save plot
ggsave("between_burrow.png", 
       width = 300, height = 250, unit = "mm")

```


## Max, min, mean - That needs making in GIMP

```{r}

library(tidyr)

## Daily max, min and mean - no gray lines

## Summarise the daily max, min and mean for each burrow
maxmin <- ATPU_LSSP %>% filter(Location == "Inside") %>%
  group_by(Date, Burrow, Species) %>%
  summarise(`Daily Mean` = mean(temp),
            `Daily Max.` = max(temp), 
            `Daily Min.` = min(temp))

# Gather the data
maxmin2 <- maxmin %>% gather(Unit, Temperature, `Daily Mean`:`Daily Min.`)
maxmin2$Burrow <- as.character(maxmin2$Burrow)


## Daily max, min and mean - with gray lines
ATPUmaxmin <- maxmin2 %>% filter(Species == "Atlantic puffin")
LSSPmaxmin <- maxmin2 %>% filter(Species == "Leach's storm-petrel")

## Plot a facet wrap version

# Calculate the mean line
meanline <- maxmin2 %>% group_by(Species, Unit) %>%
  summarise(mean = mean(Temperature))
  

## Individual boxplots
puffin_box <- ggplot()+
  geom_boxplot(data = ATPUmaxmin, aes(x = Unit, 
                  y = Temperature, 
                  fill = Unit), 
               outlier.shape = NA,
               width = 0.5)+
    scale_fill_manual(values = c("#E16E08", "#F9E07F","#89B4C7")) +
    plottheme+
    guides(alpha = FALSE, fill = FALSE, colour = FALSE)+
  facet_wrap(~Unit, scales = "free_x", ncol = 1)+
  theme(strip.text.x = element_blank(),
        strip.text.y = element_blank(),
        strip.background = element_blank())+
    scale_y_continuous(breaks=seq(12,25,4))+
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())

petrel_box <- ggplot()+
  geom_boxplot(data = LSSPmaxmin, aes(x = Unit, 
                  y = Temperature, 
                  fill = Unit), 
               outlier.shape = NA,
               width = 0.5)+
    scale_fill_manual(values = c("#E16E08", "#F9E07F","#89B4C7")) +
    plottheme+
    guides(alpha = FALSE, fill = FALSE, colour = FALSE)+
  facet_wrap(~Unit, scales = "free_x", ncol = 1)+
  theme(strip.text.x = element_blank(),
        strip.text.y = element_blank(),
        strip.background = element_blank())+
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())


## Summarise the mean daily temperatures across all burrows so that we can order
## the main plot by decreaing mean temp
mean <- filter(maxmin2, Unit =="Daily Mean") %>% group_by(Species, Burrow) %>% 
  summarise(mean = mean(Temperature))

## Match to the means to the maxmin2 dataframe
maxmin2 <- left_join(maxmin2, mean)

## Filter the data for the two species for the analyses below
ATPU <- maxmin2 %>% filter(Species == "Atlantic puffin")
LSSP <- maxmin2 %>% filter(Species == "Leach's storm-petrel")


# Create the between burrow variation violin plot
## Atlantic puffins
violin_ATPU<- ggplot()+
  geom_violin(data = ATPU, 
              aes(x = reorder(Burrow, -mean), 
                  y = Temperature, 
                  fill = Unit, colour = Unit))+
  scale_fill_manual(values = c("#E16E08", "#F9E07F","#89B4C7")) +
  scale_colour_manual(values = c( "#E16E08","#F9E07F","#89B4C7")) +
  ylab("Temperature (°C)")+
  plottheme+
  guides(alpha = FALSE, fill = FALSE, colour = FALSE)+
  facet_grid(Unit ~.)+
  theme(strip.text.x = element_blank(),
        strip.text.y = element_blank(),
        strip.background = element_blank())+
  geom_hline(data = filter(meanline,Species == "Atlantic puffin"), aes(yintercept = mean), linetype = "dashed")+
  theme(axis.title.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  scale_y_continuous(breaks=seq(12,25,4))


## Leach's storm-petrels
violin_LSSP<- ggplot()+
  geom_violin(data = LSSP, 
              aes(x = reorder(Burrow, -mean), 
                  y = Temperature, 
                  fill = Unit, colour = Unit))+
  scale_fill_manual(values = c("#E16E08", "#F9E07F","#89B4C7")) +
  scale_colour_manual(values = c( "#E16E08","#F9E07F","#89B4C7")) +
  xlab("Burrow ID") + ylab("Temperature (°C)")+
  plottheme+
  guides(alpha = FALSE, fill = FALSE, colour = FALSE)+
  facet_grid(Unit ~.)+
  theme(strip.text.x = element_blank(),
        strip.text.y = element_blank(),
        strip.background = element_blank())+
  geom_hline(data = filter(meanline,Species == "Leach's storm-petrel"), aes(yintercept = mean), linetype = "dashed")+
   theme(axis.title.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())



## Combine the plots
library(patchwork)

(violin_ATPU + puffin_box + plot_layout(widths=c(2,0.25))) / (violin_LSSP + petrel_box + plot_layout(widths=c(2,0.25))) 

## Save plot
ggsave("burrow_boxplots.png", 
       width = 300, height = 250, unit = "mm")

```





## Max, min, mean - final plot - NOT THIS ONE
```{r}

library(tidyr)

## Daily max, min and mean - no gray lines

## Summarise the daily max, min and mean for each burrow
maxmin <- ATPU_LSSP %>% filter(Location == "Inside") %>%
  group_by(Date, Burrow, Species) %>%
  summarise(`Daily Mean` = mean(temp),
            `Daily Max.` = max(temp), 
            `Daily Min.` = min(temp))

# Gather the data
maxmin2 <- maxmin %>% gather(Unit, Temperature, `Daily Mean`:`Daily Min.`)
maxmin2$Burrow <- as.character(maxmin2$Burrow)


## Daily max, min and mean - with gray lines
ATPUmaxmin <- maxmin2 %>% filter(Species == "Atlantic puffin")
LSSPmaxmin <- maxmin2 %>% filter(Species == "Leach's storm-petrel")

## Plot a facet wrap version

# Calculate the mean line
meanline <- maxmin2 %>% group_by(Species, Unit) %>%
  summarise(mean = mean(Temperature))
  
# Create the plot
ggplot()+
  geom_violin(data = maxmin2, aes(x = reorder(Burrow, -Temperature), 
                  y = Temperature, 
                  fill = Unit, colour = Unit))+
  scale_fill_manual(values = c("#E16E08", "#F9E07F","#89B4C7")) +
  scale_colour_manual(values = c( "#E16E08","#F9E07F","#89B4C7")) +
  xlab("Burrow ID") + ylab("Temperature (°C)")+
  plottheme+
  guides( alpha = FALSE, fill = FALSE, colour = FALSE)+
  facet_grid(Unit~Species, scales = "free")+
  theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"),
        strip.text.y = element_text(size = 16, color = "white", face = "bold"),
        strip.background = element_rect(fill="black"))+
  geom_hline(data = meanline, aes(yintercept = mean), linetype = "dashed")


```

## Max, min, mean - an array of plots - NOT THIS ONE

```{r}

# Violin - overall burrow variation
ggplot(filter(ATPU_LSSP, Location == "Inside"), aes(x = reorder(Burrow, -temp), y = temp))+
  #geom_jitter(shape=16, position=position_jitter(0.3), alpha = 0.1)+
  geom_violin(draw_quantiles = c(0.5), alpha = 0.9)+
  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Burrow") + ylab("Temperature (°C)")+
  theme(axis.title.y = element_text(vjust = 3))+
  theme(axis.title.x = element_text(vjust = -1))+
  facet_wrap(~Species, scales = "free_x")

library(tidyr)

## Daily max, min and mean - no gray lines

## Summarise the daily max, min and mean for each burrow
maxmin <- ATPU_LSSP %>% filter(Location == "Inside") %>%
  group_by(Date, Burrow, Species) %>%
  summarise(`Daily Mean` = mean(temp),
            `Daily Max.` = max(temp), 
            `Daily Min.` = min(temp))

# Gather the data
maxmin2 <- maxmin %>% gather(Unit, Temperature, `Daily Mean`:`Daily Min.`)
maxmin2$Burrow <- as.character(maxmin2$Burrow)


 # Create data.frame with shading info
shading <- data.frame(min = seq(from = 0.5, to = 
                                  max(as.numeric(as.factor(maxmin2$Burrow))), by = 1),
           max = seq(from = 1.5, to = max(as.numeric(as.factor(maxmin2$Burrow))) + 0.5, by = 1),
           col = c(0,1))

ggplot()+
  geom_violin(data = maxmin2, 
              aes(x = reorder(Burrow, -Temperature), 
                  y = Temperature, 
                  fill = Unit,
                  colour = Unit), position = position_dodge(width = 0.6))+
#stat_summary(fun.y=mean, geom="point", shape=23, size=2)
#  geom_rect(data = shading,
  #          aes(xmin = min, xmax = max, ymin = -Inf, ymax = Inf,
  #              fill = factor(col), alpha = 0.05)) +
  #scale_fill_manual(values = c("white", "gray90",  "#E16E08", "#43A407","#89B4C7")) +
  scale_fill_manual(values = c("#E16E08", "#F9E07F","#89B4C7")) +
   scale_colour_manual(values = c("#E16E08","#F9E07F","#89B4C7")) +
 # geom_violin(data = maxmin2, aes(x = reorder(Burrow, -Temperature), y = Temperature, fill = Unit, colour = Unit))+
    theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Burrow ID") + ylab("Temperature (°C)")+
  theme(axis.title.y = element_text(vjust = 3))+
  theme(axis.title.x = element_text(vjust = -1))+
    guides( alpha = FALSE, fill = FALSE, colour = FALSE)+
  facet_wrap(~Species, scales = "free", ncol = 1)+
    theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"),
        strip.background = element_rect(fill="black"))




## Daily max, min and mean - with gray lines
ATPUmaxmin <- maxmin2 %>% filter(Species == "Atlantic puffin")
LSSPmaxmin <- maxmin2 %>% filter(Species == "Leach's storm-petrel")


 # Create data.frame with shading info
ATPUshading <- data.frame(min = seq(from = 0.5, to = 
                                  max(as.numeric(as.factor(ATPUmaxmin$Burrow))), by = 1),
           max = seq(from = 1.5, to = max(as.numeric(as.factor(ATPUmaxmin$Burrow))) + 0.5, by = 1),
           col = c(0,1))


LSSPshading <- data.frame(min = seq(from = 0.5, to = 
                                  max(as.numeric(as.factor(LSSPmaxmin$Burrow))), by = 1),
           max = seq(from = 1.5, to = max(as.numeric(as.factor(LSSPmaxmin$Burrow))) + 0.5, by = 1),
           col = c(0,1))


# ATPU plot
atpu<-ggplot()+
  geom_violin(data = ATPUmaxmin, 
              aes(x = reorder(Burrow, -Temperature), 
                  y = Temperature, 
                  fill = Unit, colour = Unit, colour = Unit), position = position_dodge(width = 0.6))+
 geom_rect(data = ATPUshading,
         aes(xmin = min, xmax = max, ymin = -Inf, ymax = Inf,
              fill = factor(col), alpha = 0.05)) +
  scale_fill_manual(values = c("white", "gray90",  "#E16E08", "#F9E07F","#89B4C7")) +
   scale_colour_manual(values = c("#E16E08","#F9E07F","#89B4C7")) +
 geom_violin(data = ATPUmaxmin, aes(x = reorder(Burrow, -Temperature), 
                                    y = Temperature, fill = Unit, colour = Unit),
             position = position_dodge(width = 0.6))+
    theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Burrow ID") + ylab("Temperature (°C)")+
  theme(axis.title.y = element_text(vjust = 3))+
  theme(axis.title.x = element_text(vjust = -1))+
    guides( alpha = FALSE, fill = FALSE, colour = FALSE)+
  facet_wrap(~Species)+
    theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"),
        strip.background = element_rect(fill="black"),
         axis.title.x = element_blank())
 




# LSSP plot
lssp<-ggplot()+
  geom_violin(data = LSSPmaxmin, 
              aes(x = reorder(Burrow, -Temperature), 
                  y = Temperature, 
                  fill = Unit, colour = Unit), position = position_dodge(width = 0.6))+
 geom_rect(data = LSSPshading,
         aes(xmin = min, xmax = max, ymin = -Inf, ymax = Inf,
              fill = factor(col), alpha = 0.05)) +
  scale_fill_manual(values = c("white", "gray90",  "#E16E08", "#F9E07F","#89B4C7")) +
  scale_colour_manual(values = c("#E16E08","#F9E07F","#89B4C7")) +
 geom_violin(data = LSSPmaxmin, aes(x = reorder(Burrow, -Temperature), 
                                    y = Temperature, fill = Unit, colour = Unit),
             position = position_dodge(width = 0.6))+
    theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Burrow ID") + ylab("Temperature (°C)")+
  theme(axis.title.y = element_text(vjust = 3))+
  theme(axis.title.x = element_text(vjust = -1))+
    guides( alpha = FALSE, fill = FALSE, colour = FALSE)+
  facet_wrap(~Species)+
    theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"),
        strip.background = element_rect(fill="black"))

# joined plot
atpu / lssp



## Plot a facet wrap version

# Calculate the mean line
meanline <- maxmin2 %>% group_by(Species, Unit) %>%
  summarise(mean = mean(Temperature))
  
# Create the plot
ggplot()+
  geom_violin(data = maxmin2, aes(x = reorder(Burrow, -Temperature), 
                  y = Temperature, 
                  fill = Unit, colour = Unit))+
  scale_fill_manual(values = c("#E16E08", "#F9E07F","#89B4C7")) +
  scale_colour_manual(values = c( "#E16E08","#F9E07F","#89B4C7")) +
  xlab("Burrow ID") + ylab("Temperature (°C)")+
  plottheme+
  guides( alpha = FALSE, fill = FALSE, colour = FALSE)+
  facet_grid(Unit~Species, scales = "free")+
  theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"),
        strip.text.y = element_text(size = 16, color = "white", face = "bold"),
        strip.background = element_rect(fill="black"))+
  geom_hline(data = meanline, aes(yintercept = mean), linetype = "dashed")



```


## Buffer

```{r}

library(tidyr)

## Sort the data
buffer <- ATPU_LSSP %>% select(datetime, Date, Time, Species, Burrow, Plot, Location, temp)
buffer <- buffer %>% spread(Location, temp)

## Calculate the buffer
buffer$offset <- buffer$Inside-buffer$Outside

## Identify the extreme events
## Here we define "extreme" as the 1 and 99 percentiles
quant <- buffer %>%
  group_by(Species) %>%
  summarise(quantile1 = quantile(Outside, c(.01), na.rm = T),
            quantile99 = quantile(Outside, c(.99), na.rm = T))


## Filter out the extreme temperatures (Leach's)
extreme_cold_LSSP <- filter(buffer, Outside <= 7.2 & Species == "Leach's storm-petrel")
extreme_cold_LSSP$Extreme <- "Cold Extreme"
mean(extreme_cold_LSSP$offset)

extreme_heat_LSSP <- filter(buffer, Outside >= 26.2 & Species == "Leach's storm-petrel")
extreme_heat_LSSP$Extreme <- "Heat Extreme"
mean(extreme_heat_LSSP$offset)


## Filter out the extreme temperatures (Puffin)
extreme_cold_ATPU <- filter(buffer, Outside <= 10.3 & Species == "Atlantic puffin")
extreme_cold_ATPU$Extreme <- "Cold Extreme"
mean(extreme_cold_ATPU$offset, na.rm = T)

extreme_heat_ATPU <- filter(buffer, Outside >= 40.4 & Species == "Atlantic puffin")
extreme_heat_ATPU$Extreme <- "Heat Extreme"
mean(extreme_heat_ATPU$offset, na.rm = T)



## Join the dataframes
extreme <- rbind(extreme_cold_LSSP, extreme_heat_LSSP, 
                 extreme_cold_ATPU, extreme_heat_ATPU)


# Jitter plot
extreme_violin<- ggplot(extreme, aes(x = Extreme, y = offset)) +
  #geom_jitter(position=position_jitter(0.2), alpha = 0.2, aes(colour = offset>0))+
  geom_boxplot( aes(fill = offset>0))+
   stat_summary(fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    geom = "pointrange", color = "black"
    )+
  #geom_boxplot(width = 0.1)+
  #scale_colour_manual(values = c("#89B4C7", "#E16E08"))+
  scale_fill_manual(values = c("#89B4C7", "#E16E08"))+
  ylab(bquote(T[Buffer]~"(°C)"))+
  geom_hline(yintercept = 0, linetype="dashed", size = 1)+
    plottheme+
  theme(legend.position = "none")+
  facet_wrap(~Species)+
    theme(strip.text.x = element_blank(), 
          strip.background = element_blank(),
          axis.title.x = element_blank())


## Create correlation
corr_plot<-ggplot(buffer, aes(x=Outside, y = offset))+
  geom_point(alpha = 0.2)+
  ylab(bquote(T[Buffer]~"(°C)"))+
  xlab("External Burrow Temperature (°C)")+
  theme_bw(base_size = 20)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  theme(axis.title.y = element_text(vjust = 3)) +
  facet_wrap(~Species)+
   theme(strip.text.x = element_blank(), 
          strip.background = element_blank())


# create the stacked plot
tempall / corr_plot / extreme_violin


ggsave("stacked_buffer.png", 
       dpi = 600, 
       width = 250, height = 300, unit = "mm")


```




## Buffer updated plot

```{r}

library(tidyr)

## Sort the data
buffer <- ATPU_LSSP %>% select(datetime, Date, Time, Species, Burrow, Plot, Location, temp)
buffer <- buffer %>% spread(Location, temp)

## Calculate the buffer
buffer$offset <- buffer$Inside-buffer$Outside

## Identify the extreme events
## Here we define "extreme" as the 1 and 99 percentiles
quant <- buffer %>%
  group_by(Species) %>%
  summarise(quantile1 = quantile(Outside, c(.01), na.rm = T),
            quantile99 = quantile(Outside, c(.99), na.rm = T))


## Filter out the extreme temperatures (Leach's)
extreme_cold_LSSP <- filter(buffer, Outside <= 7.2 & Species == "Leach's storm-petrel")
extreme_cold_LSSP$Extreme <- "Cold Extreme"
mean(extreme_cold_LSSP$offset)

extreme_heat_LSSP <- filter(buffer, Outside >= 26.2 & Species == "Leach's storm-petrel")
extreme_heat_LSSP$Extreme <- "Heat Extreme"
mean(extreme_heat_LSSP$offset)


## Filter out the extreme temperatures (Puffin)
extreme_cold_ATPU <- filter(buffer, Outside <= 10.3 & Species == "Atlantic puffin")
extreme_cold_ATPU$Extreme <- "Cold Extreme"
mean(extreme_cold_ATPU$offset, na.rm = T)

extreme_heat_ATPU <- filter(buffer, Outside >= 40.4 & Species == "Atlantic puffin")
extreme_heat_ATPU$Extreme <- "Heat Extreme"
mean(extreme_heat_ATPU$offset, na.rm = T)



## Join the dataframes
extreme <- rbind(extreme_cold_LSSP, extreme_heat_LSSP, 
                 extreme_cold_ATPU, extreme_heat_ATPU)


# Jitter plot
# puffins
extreme_puffin<- ggplot(filter(extreme, Species == "Atlantic puffin"), aes(x = Extreme, y = offset)) +
  geom_boxplot( aes(fill = offset>0))+
  scale_fill_manual(values = c("#89B4C7", "#E16E08"))+
  ylab(bquote(T[Buffer]~"(°C)"))+ xlab("Thermal Event")+
  geom_hline(yintercept = 0, linetype="dashed", size = 1)+
    plottheme+
  theme(legend.position = "none")+
  facet_wrap(~Species)+
    theme(strip.text.x = element_blank(), 
          strip.background = element_blank())

# petrels
extreme_petrel<- ggplot(filter(extreme, Species == "Leach's storm-petrel"), aes(x = Extreme, y = offset)) +
  geom_boxplot( aes(fill = offset>0))+
  scale_fill_manual(values = c("#89B4C7", "#E16E08"))+
  ylab(bquote(T[Buffer]~"(°C)"))+ xlab("Thermal Event")+
  geom_hline(yintercept = 0, linetype="dashed", size = 1)+
    plottheme+
  theme(legend.position = "none")+
  facet_wrap(~Species)+
    theme(strip.text.x = element_blank(), 
          strip.background = element_blank())


## Create correlation
# Puffins
corr_puffin<-ggplot(filter(buffer, Species == "Atlantic puffin"), aes(x=Outside, y = Inside))+
  geom_point(alpha = 0.2)+
  ylab(bquote(T[Internal]~"(°C)"))+
  xlab(bquote(T[External]~"(°C)"))+
  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  theme(axis.title.y = element_text(vjust = 3)) +
  facet_wrap(~Species)+
    plottheme+
   theme(strip.text.x = element_blank(), 
          strip.background = element_blank())

# petrels
corr_petrel<-ggplot(filter(buffer, Species == "Leach's storm-petrel"), aes(x=Outside, y = Inside))+
  geom_point(alpha = 0.2)+
  ylab(bquote(T[Internal]~"(°C)"))+
  xlab(bquote(T[External]~"(°C)"))+
  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  theme(axis.title.y = element_text(vjust = 3)) +
  facet_wrap(~Species)+
   plottheme+
   theme(strip.text.x = element_blank(), 
          strip.background = element_blank())



# Temp trend Plot
tempall <- ggplot(data = season_mean_temp, aes(x = datetime, y = mean, group = Location))+
  geom_line(aes(colour = Location, linetype = Location))+
  geom_ribbon(aes(ymin=mean-sd, ymax=mean+sd, fill = Location), alpha = 0.4)+
  plottheme+
  theme(legend.title = element_blank())+ 
  ylab("Temperature (°C)")+
  scale_colour_manual(values = c("#43A407", "#4E342E"))+
  scale_fill_manual(values = c("#43A407", "#4E342E"))+
  theme(legend.position = c(0.85, 0.70))+
  facet_wrap(~Species, scales = "free_x")+
  theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"), 
        strip.background = element_rect(fill="black"),
        axis.title.x = element_blank())



# create the stacked plot
tempall / (corr_puffin | extreme_puffin | corr_petrel | extreme_petrel) 


# save the plot
ggsave("stacked_buffer2.png", 
       dpi = 600, 
       width = 350, height = 150, unit = "mm")


```






## Buffer - weather version

- why are there gaps in the beginning - cut off too early in the weather data?

- record every 30 mins? remove the 15 minute gaps
- summarise the mean and SD for the open_join and forest_join
- what to do about the different kestrel data?



```{r}



ggplot()+
  geom_line(data = filter(season_mean_temp, Location == "Inside"),
            aes(x = datetime, y = mean))+
  geom_point(data = forest_join, aes(x = datetime2, y = Temperature, alpha = 0.3))+
  #geom_ribbon(aes(ymin=mean-sd, ymax=mean+sd, fill = Location), alpha = 0.4)+
  plottheme+
  theme(legend.title = element_blank())+ 
  ylab("Temperature (°C)")+
  #scale_colour_manual(values = c("#43A407", "#4E342E"))+
 # scale_fill_manual(values = c("#43A407", "#4E342E"))+
  theme(legend.position = c(0.85, 0.70))+
  facet_wrap(~Species, scales = "free_x")+
  theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"), 
        strip.background = element_rect(fill="black"),
        axis.title.x = element_blank())





## Identify the extreme events
## Here we define "extreme" as the 1 and 99 percentiles
quant_weather <- model_df_short %>%
  group_by(Species) %>%
  summarise(quantile1 = quantile(Temperature, c(.01), na.rm = T),
            quantile99 = quantile(Temperature, c(.99), na.rm = T))


## Filter out the extreme temperatures (Leach's)
extreme_cold_LSSP <- filter(model_df_short, Temperature <= 6.5 & Species == "Leach's storm-petrel")
extreme_cold_LSSP$Extreme <- "Cold Extreme"
mean(extreme_cold_LSSP$buffer_kestrel) # 7.3838 deg C
sd(extreme_cold_LSSP$buffer_kestrel) #1.214295

extreme_heat_LSSP <- filter(model_df_short, Temperature >= 25.7 & Species == "Leach's storm-petrel")
extreme_heat_LSSP$Extreme <- "Heat Extreme"
mean(extreme_heat_LSSP$buffer_kestrel) #-9.437 deg C
sd(extreme_heat_LSSP$buffer_kestrel) # 1.409367

## Filter out the extreme temperatures (Puffin)
extreme_cold_ATPU <- filter(model_df_short, Temperature <= 10 & Species == "Atlantic puffin")
extreme_cold_ATPU$Extreme <- "Cold Extreme"
mean(extreme_cold_ATPU$buffer_kestrel, na.rm = T) # 8.049758 deg C
sd(extreme_cold_ATPU$buffer_kestrel, na.rm = T) # 1.534774

extreme_heat_ATPU <- filter(model_df_short, Temperature >= 25.6 & Species == "Atlantic puffin")
extreme_heat_ATPU$Extreme <- "Heat Extreme"
mean(extreme_heat_ATPU$buffer_kestrel, na.rm = T) # -5.385507 deg C
sd(extreme_heat_ATPU$buffer_kestrel, na.rm = T) #1.81329


## Join the dataframes
extreme <- rbind(extreme_cold_LSSP, extreme_heat_LSSP, 
                 extreme_cold_ATPU, extreme_heat_ATPU)


# Jitter plot
# puffins
extreme_puffin<- ggplot(filter(extreme, Species == "Atlantic puffin"), 
                        aes(x = Extreme, y = buffer_kestrel)) +
  geom_boxplot( aes(fill = buffer_kestrel>0))+
  scale_fill_manual(values = c("#89B4C7", "#E16E08"))+
  ylab(bquote(T[Buffer]~"(°C)"))+ xlab("Thermal Event")+
  geom_hline(yintercept = 0, linetype="dashed", size = 1)+
    plottheme+
  theme(legend.position = "none")+
  facet_wrap(~Species)+
    theme(strip.text.x = element_blank(), 
          strip.background = element_blank())



# petrels
extreme_petrel<- ggplot(filter(extreme, Species == "Leach's storm-petrel"),
                        aes(x = Extreme, y = buffer_kestrel)) +
  geom_boxplot( aes(fill = buffer_kestrel>0))+
  scale_fill_manual(values = c("#89B4C7", "#E16E08"))+
  ylab(bquote(T[Buffer]~"(°C)"))+ xlab("Thermal Event")+
  geom_hline(yintercept = 0, linetype="dashed", size = 1)+
    plottheme+
  theme(legend.position = "none")+
  facet_wrap(~Species)+
    theme(strip.text.x = element_blank(), 
          strip.background = element_blank())


## Create correlation
# Puffins
corr_puffin<-ggplot(filter(model_df_short, Species == "Atlantic puffin"), 
                    aes(x=Temperature, y = Inside))+
  geom_point(alpha = 0.2)+
  ylab(bquote(T[Internal]~"(°C)"))+
  xlab(bquote(T[External]~"(°C)"))+
  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  theme(axis.title.y = element_text(vjust = 3)) +
  facet_wrap(~Species)+
    plottheme+
   theme(strip.text.x = element_blank(), 
          strip.background = element_blank())

# petrels
corr_petrel<-ggplot(filter(model_df_short, Species == "Leach's storm-petrel"), 
                    aes(x=Temperature, y = Inside))+
  geom_point(alpha = 0.2)+
  ylab(bquote(T[Internal]~"(°C)"))+
  xlab(bquote(T[External]~"(°C)"))+
  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  theme(axis.title.y = element_text(vjust = 3)) +
  facet_wrap(~Species)+
   plottheme+
   theme(strip.text.x = element_blank(), 
          strip.background = element_blank())


## NEED TO TEST FOR NORMALLITY FIRST

# Calculate the correlation
cor.test(lssp$Temperature, lssp$Inside) # R = 0.35 [0.34-0.36] p < 0.001
cor.test(atpu$Temperature, atpu$Inside) # R = 0.38 [0.37-0.39] p < 0.001

# Summarise the mean temperature and standard deviation for inside and outside the burrows
season <- model_df_short %>%
  group_by(Species, datetime) %>%
  summarise(mean = mean(Inside), 
            sd = sd(Inside),
            meankest = mean(Temperature),
            sdkest = sd(Temperature))


tempall <- ggplot(data = season, aes(x = datetime, y = mean))+
  geom_line(colour = "#4E342E", linetype = "dashed")+
  geom_ribbon(aes(ymin=mean-sd, ymax=mean+sd), 
              fill = "#4E342E",alpha = 0.4)+
  geom_line(aes(x = datetime, y = meankest), colour = "#43A407")+
  plottheme+
  theme(legend.title = element_blank())+ 
  ylab("Temperature (°C)")+
  theme(legend.position = c(0.85, 0.70))+
  facet_wrap(~Species, scales = "free_x")+
  theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"), 
        strip.background = element_rect(fill="black"),
        axis.title.x = element_blank())



# create the stacked plot
tempall / (corr_puffin | extreme_puffin | corr_petrel | extreme_petrel) 


# save the plot
ggsave("stacked_buffer_weather.png", 
       dpi = 600, 
       width = 350, height = 150, unit = "mm")




## STARTING TO EXPLORE THE BEST PERFORMING BUFFERING BURROWS
# 4 models - extreme hot, cold, lssp and atpu
## Identify the unique features of burrows that are under- and overperforming during extreme events. 

extreme_heat_ATPU$Burrow <- as.character(extreme_heat_ATPU$Burrow)

ggplot(extreme_heat_ATPU, aes(x = Burrow, y = buffer_kestrel)) +
  geom_boxplot()+
  ylab(bquote(T[Buffer]~"(°C)"))+ xlab("Burrow")+
  geom_hline(yintercept = 0, linetype="dashed", size = 1)+
    plottheme+
  theme(legend.position = "none")+
  facet_wrap(~Species)+
    theme(strip.text.x = element_blank(), 
          strip.background = element_blank())

```


## WEATHER 

## Individual plots

```{r}
# Weather temperature trend
ggplot(data = weather, aes(x = time, y = Temperature))+
  geom_line()+
  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Date") + ylab("Temperature (°C)")+
  theme(axis.title.y = element_text(vjust = 3))+
  theme(axis.title.x = element_text(vjust = -1))+
  #scale_x_datetime(date_breaks = "10 days", date_labels = "%d %b")+
  facet_wrap(~Station, scales = "free_y", ncol = 2, nrow = 1)+
  theme(strip.text.x = element_text(size = 15, color = "white"), 
        strip.background = element_rect(fill="black"))



# Barometric pressure trend
ggplot(data = weather, aes(x = time, y = Barometric.Pressure))+
  geom_line()+geom_point(shape = 21, colour = "black", fill = "white")+
  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Date") + ylab("Barometric Pressure (mb)")+
  theme(axis.title.y = element_text(vjust = 3))+
  theme(axis.title.x = element_text(vjust = -1))+
  #scale_x_datetime(date_breaks = "10 days", date_labels = "%d %b")+
  facet_wrap(~Station, ncol = 2, nrow = 1)+
  theme(strip.text.x = element_text(size = 15, color = "white"), 
        strip.background = element_rect(fill="black"))



# Wind speed trend
ggplot(data = weather, aes(x = time, y = Wind.Speed))+
  geom_line()+
  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Date") + ylab("Wind Speed (km/h)")+
  theme(axis.title.y = element_text(vjust = 3))+
  theme(axis.title.x = element_text(vjust = -1))+
  #scale_x_datetime(date_breaks = "10 days", date_labels = "%d %b")+
  facet_wrap(~Station, ncol = 2, nrow = 1)+
  theme(strip.text.x = element_text(size = 15, color = "white"), 
        strip.background = element_rect(fill="black"))


# Crosswind trend
ggplot(data = weather, aes(x = time, y = Crosswind))+
  geom_line()+
  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Date") + ylab("Crosswind (km/h)")+
  theme(axis.title.y = element_text(vjust = 3))+
  theme(axis.title.x = element_text(vjust = -1))+
  #scale_x_datetime(date_breaks = "10 days", date_labels = "%d %b")+
  facet_wrap(~Station, ncol = 2, nrow = 1)+
  theme(strip.text.x = element_text(size = 15, color = "white"), 
        strip.background = element_rect(fill="black"))



# headwind trend
ggplot(data = weather, aes(x = time, y = Headwind))+
  geom_line()+
  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Date") + ylab("Headwind (km/h)")+
  theme(axis.title.y = element_text(vjust = 3))+
  theme(axis.title.x = element_text(vjust = -1))+
  #scale_x_datetime(date_breaks = "10 days", date_labels = "%d %b")+
  facet_wrap(~Station, ncol = 2, nrow = 1)+
  theme(strip.text.x = element_text(size = 15, color = "white"), 
        strip.background = element_rect(fill="black"))



# Wind Chill trend
ggplot(data = weather, aes(x = time, y = Wind.Chill))+
  geom_line()+
  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Date") + ylab("Wind Chill (°C)")+
  theme(axis.title.y = element_text(vjust = 3))+
  theme(axis.title.x = element_text(vjust = -1))+
  #scale_x_datetime(date_breaks = "10 days", date_labels = "%d %b")+
  facet_wrap(~Station, ncol = 2, nrow = 1)+
  theme(strip.text.x = element_text(size = 15, color = "white"), 
        strip.background = element_rect(fill="black"))


# humidity trend
ggplot(data = weather, aes(x = time, y = Relative.Humidity))+
  geom_line()+
  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Date") + ylab("Relative Humidity (%)")+
  theme(axis.title.y = element_text(vjust = 3))+
  theme(axis.title.x = element_text(vjust = -1))+
  #scale_x_datetime(date_breaks = "10 days", date_labels = "%d %b")+
  facet_wrap(~Station, ncol = 2, nrow = 1)+
  theme(strip.text.x = element_text(size = 15, color = "white"), 
        strip.background = element_rect(fill="black"))


```


## Stacked 

```{r}

# Weather temperature trend
tempfacet <- ggplot(data = weather, aes(x = DateTime, y = Temperature))+
  geom_line()+
  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  ylab("Temperature (°C)")+
    theme(axis.title.x =element_blank(),
        axis.text.x =element_blank(),
        axis.ticks.x=element_blank())+
  theme(axis.title.y = element_text(vjust = 3))+
  facet_wrap(~Station,ncol = 2, nrow = 1)+
  theme(strip.text.x = element_text(size = 15, color = "white"), 
        strip.background = element_rect(fill="black"))

# Wind speed trend
wind <- ggplot(data = weather, aes(x = DateTime, y = Wind.Speed))+
  geom_bar(stat="identity")+
  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  ylab("Wind Speed (km/h)")+
  theme(axis.title.x =element_blank(),
        axis.text.x =element_blank(),
        axis.ticks.x=element_blank())+
  theme(axis.title.y = element_text(vjust = 3))+
  facet_wrap(~Station, ncol = 2, nrow = 1)+
  theme(strip.background = element_blank(),
      strip.text.x = element_blank())



# Barometric pressure trend
pressure <- ggplot(data = weather, aes(x = DateTime, y = Barometric.Pressure))+
  geom_line()+
  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Date") + ylab("Barometric Pressure (mb)")+
  theme(axis.title.y = element_text(vjust = 3))+
  theme(axis.title.x = element_text(vjust = -1))+
  facet_wrap(~Station, ncol = 2, nrow = 1)+
  theme(strip.background = element_blank(),
      strip.text.x = element_blank())




# create the combined plot 
library(patchwork)

tempfacet / wind / pressure


# Save the image
ggsave("weather_plot.png", 
       dpi = 600, 
       width = 300, height = 200, unit = "mm")


```


## Create a tile plot of temperature

```{r}

library(ggplot2)

# Weather temperature trend
temp <- ggplot(data = weather1, aes(x = DateTime, y = Temperature))+
  geom_line()+
  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  xlab("Date") + ylab("Temperature (°C)")+
  theme(axis.title.y = element_text(vjust = 3))+
  theme(axis.title.x = element_text(vjust = -1))+
    theme(axis.title.x =element_blank(),
        axis.text.x =element_blank(),
        axis.ticks.x=element_blank())



heat <- ggplot(weather2, aes(x = Date, y = Time, fill = Temperature)) +
  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), # remove the major lines
        panel.grid.minor = element_blank())+
  geom_tile(colour = "white", size = 0.15)+
  scale_fill_distiller(palette = "RdYlBu", direction = -1)+
  ylab("Time of Day (h)")+ theme(axis.title.y = element_text(vjust = 3)) +
  theme(legend.position="bottom")+
  guides(fill = guide_colourbar(barwidth = 10, barheight = 0.5))





library(patchwork)

temp / heat

```





## STATISTICAL SECTION


```{r}
library(nlme)

## First look at the overall trend between the burrows
##PUFFINS

# Run a linear mixed-effects model
m1 <- lme(temp ~ Burrow, 
    random = ~1|datetime, 
    data=filter(ATPU_LSSP, Species == "Atlantic puffin" & Location == "Inside"))

qqnorm(m1)
plot(m1)
hist(resid(m1))
summary(m1)

# 95% confidence intervals
intervals(m1)

# Test whether a gls would provide a better fit
m2 <- gls(temp ~ Burrow, 
    data=filter(ATPU_LSSP, Species == "Atlantic puffin" & Location == "Inside"))

# Add temporal autocorrelation
m3 <- gls(temp ~ Burrow,
          cor=corARMA(q=4,form=~1|datetime),
    data=filter(ATPU_LSSP, Species == "Atlantic puffin" & Location == "Inside"))

# Compare the three models
# m1 has the lowest AIC score
anova(m1, m2, m3)










modelling <- ATPU_LSSP %>% filter(Location == "Inside") %>%
  group_by(Date, Burrow, Species) %>%
  summarise(Mean = mean(temp),
            Max = max(temp), 
            Min = min(temp))




# build model to test the inter-nest differences in temperatures

m.mean.puffin <- lme(Mean ~ Burrow, 
    random = ~1|Date, 
    data=filter(modelling, Species == "Atlantic puffin"))

summary(m.mean.puffin)


m.mean.petrel <- lme(Mean ~ Burrow, 
    random = ~1|Date, 
    data=filter(modelling, Species == "Leach's storm-petrel"))

hist(resid(m.mean.petrel))
plot(m.mean.petrel)



m1 <- lme(temp ~ Burrow, 
    random = ~1|datetime, 
    data=filter(ATPU_LSSP, Species == "Atlantic puffin" & Location == "Inside"))



m1 <- lm(temp ~ Burrow, 
    data=filter(ATPU_LSSP, Species == "Atlantic puffin" & Location == "Inside"))



```


## Summary statistics

```{r}

## Calculate the mean variance between burrows
mean_puffin <- ATPU_LSSP %>% filter(Location == "Inside") %>%
  group_by(Burrow, Species) %>%
  summarise(var = var(temp))

# The mean variation between the burrows
mean_puffin %>% group_by(Species) %>%
  summarise(mean = mean(var),
            sd = sd(var))



## The mean burrow temperatures
ATPU_LSSP %>% 
  group_by(Species, Location) %>%
  summarise(mean = mean(temp),
            sd = sd(temp))



```




## Burrow Features


WEATHER
- match the weather data (30 mins) to the burrow temps (15 minutes) or the other way around?

- predict a good burrow?


```{r}

library(dplyr);library(tidyr)

# Summarise the mean values for each of the burrow features
burrow_means <- burrows %>% group_by(Species) %>%
  summarise(logger.depth = mean(Logger.depth, na.rm =T),
            logger.depth.sd = sd(Logger.depth, na.rm =T),
            elevation = mean(Elevation),
            elevation.sd = sd(Elevation),
            width = mean(Width, na.rm =T),
            width.sd = sd(Width, na.rm =T),
            height = mean(Height, na.rm =T),
            height.sd = sd(Height, na.rm =T),
            depth = mean(Depth, na.rm =T),
            depth.sd = sd(Depth, na.rm =T),
            enter.area = mean(Enterance_Area, na.rm =T),
            enter.area.sd = sd(Enterance_Area, na.rm =T))


```

## Calculate the circular mean and SD for burrow orientation

```{r}
library(circular)

## Filter the data for the two species for the analyses below
ATPU <- burrows %>% filter(Species == "ATPU")
LSSP <- burrows %>% filter(Species == "LSSP")

## Function to convert degrees to radians and radians to degrees
## because the circular functions below require radians 
deg2rad <- function(deg) return(deg*pi/180)
rad2deg <- function(rad) {(rad * 180) / (pi)}

## Convert the burrow orientation from degrees to radians
ATPU$orient.rad <- deg2rad(ATPU$Burrow.orientation)
LSSP$orient.rad <- deg2rad(LSSP$Burrow.orientation)


## Calculate the circular mean for burrow orientation

## Atlantic puffins:
mean.circular(ATPU$orient.rad)
# Convert back to degrees
rad2deg(1.774017) ## = 101.64

## Leach's storm-petrels:
mean.circular(LSSP$orient.rad)
# Convert back to degrees
rad2deg(2.341953) ## = 134.18

## Calculate the SD for burrow orientation

## Atlantic puffins:
sd.circular(ATPU$orient.rad)
# Convert back to degrees
rad2deg(0.5637363) ## = 32.30

## Leach's storm-petrels:
sd.circular(LSSP$orient.rad)
# Convert back to degrees
rad2deg(1.222865) ## = 70.07

```



## CHANGE POINT ANALYSIS

Run a change point analysis with package `changepoint` which finds changes in mean/variance of the internal burrow temperature to identify whether there was a significant change when the extreme seasonal events hit. 

```{r}

library(changepoint)

# Filter the data
puffin <- filter(ATPU_LSSP, Location == "Inside" & Species == "Atlantic puffin")
petrel <- filter(ATPU_LSSP, Location == "Inside" & Species == "Leach's storm-petrel")

# Atlantic puffin burrows
# Here we will identify changepoints in the internal puffin burrow data based on
# the changes in the mean and variance of each burrow

# Create empty spaces for results to be pasted
burrow = cpt1 = cpt2 = numeric()

# We're taking the longer route around here in our loop because
# I couldn't work out the shorter way...

# Run the loop
# Identify the individual puffin burrows (n = 24)
for(i in unique(puffin$Burrow)){
  
# Filter the data to select 
x <- filter(ATPU_LSSP, Location == "Inside" & Species == "Atlantic puffin" & Burrow == i) 

# Identify the change points
# For some reason it doesn't allow the two to be pasted under one another
# So here we just make two columns and will join them later
cpt1[i] <- cpts(cpt.meanvar(x$temp, method = "BinSeg", Q=2))[1]
cpt2[i] <- cpts(cpt.meanvar(x$temp, method = "BinSeg", Q=2))[2]

# Assign the burrow number
burrow[i] <- i
}

# Create the dataframe containing all the information
puffincpt <- data.frame(burrow, cpt1, cpt2) %>% arrange(cpt1)

# Delete the NA rows
# I think the function is assigning the changepoints to the rows based on the burrow numbers
# So making 43 rows because the max burrow number is 43
# We will just remove the extra NA rows
puffincpt <- puffincpt %>% drop_na()

# Gather the changepoint data
puffincpt <- puffincpt %>% gather(order, cpt, cpt1:cpt2)

# Find the dates
puffincpt$Date <- x$Date[puffincpt$cpt]

# Identify how many of the burrows fall within the range of the heat extremes
# 04/08/2021 - 08/08/2021 - heat extreme 1 range
# 14/08/2021 - heat extreme 2 beginning

# Heat extreme 1 = 21/24 burrows 
cptsummary <- puffincpt %>% filter(Date >= "2021-08-04") %>% 
  filter(Date <= "2021-08-08") %>% distinct(burrow, .keep_all = TRUE)

# Heat extreme 2 = 1/24 burrows 
cptsummary <- puffincpt %>% filter(Date >= "2021-08-14") %>% 
  distinct(burrow, .keep_all = TRUE)



# PETREL
# Run just based on variance rather than mean+var because it identifies 
# the changepoints better for the petrel data

# Create empty spaces for results to be pasted
burrow = cpt1 = cpt2 = cpt3 = numeric()

# Run the loop
for(i in unique(petrel$Burrow)){
  
# Filter the data to select 
x <- filter(ATPU_LSSP, Location == "Inside" & 
              Species == "Leach's storm-petrel" & Burrow == i) 

# Identify the change points
cpt1[i] <- cpts(cpt.var(x$temp, method = "BinSeg", Q=3))[1]
cpt2[i] <- cpts(cpt.var(x$temp, method = "BinSeg", Q=3))[2]
cpt3[i] <- cpts(cpt.var(x$temp, method = "BinSeg", Q=3))[3]

# Assign burrow number
burrow[i] <- i
}

# Create the dataframe containing all the information
petrelcpt <- data.frame(burrow, cpt1, cpt2, cpt3) %>% arrange(cpt1)

# Delete the NA rows
petrelcpt <- petrelcpt %>% drop_na()

# Gather the changepoint data
petrelcpt <- petrelcpt %>% gather(order, cpt, cpt1:cpt3)

# Find the dates
petrelcpt$Date <- x$Date[petrelcpt$cpt]


# Identify how many of the burrows fall within the range of the heat extremes
# 14/08/2021 - 19/08/2021 - heat extreme 2 range
# 11/09/2021 - Hurricane Larry
# 20/09/2021 - 21/09/2021 - Cyclone Odette range

# Heat extreme 2 = 20/30 burrows
cptsummary <- petrelcpt %>% filter(Date >= "2021-08-14") %>% 
  filter(Date <= "2021-08-19") %>% distinct(burrow, .keep_all = TRUE)

# Larry = 2/30
cptsummary <- petrelcpt %>% filter(Date == "2021-09-11") %>% 
  distinct(burrow, .keep_all = TRUE)

# Odette = 26/30 burrows 
cptsummary <- petrelcpt %>% filter(Date >= "2021-09-20") %>% 
  distinct(burrow, .keep_all = TRUE)



## Can use the code below to look at specific patterns within individual burrows
# Just change the burrow number to look at specific burrows

x <- filter(ATPU_LSSP, Location == "Inside" & Species == "Atlantic puffin" & Burrow == "37")
x1 <- cpt.meanvar(x$temp, method = "BinSeg", Q=2)
plot(x1)
print(x1)

x <- filter(ATPU_LSSP, Location == "Inside" & Burrow == "81" & Species == "Leach's storm-petrel")
x1 <- cpt.var(x$temp, method = "BinSeg", Q=3)
plot(x1)
print(x1)


```





