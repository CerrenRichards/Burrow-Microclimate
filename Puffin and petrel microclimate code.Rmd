---
title: '"Puffin and Petrel 2021 - Nov 11th 2021"'
author: "Cerren Richards"
date: "11/11/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##______________________________________________________________
## Code Contents
##______________________________________________________________

1. Format the metadata

2. Format the weather data

3. Format the PUFFIN temperature data

4. Format the PETREL temperature data

5. Join the formatted puffin and petrel data

6. Calculate the burrow temperature buffering

7. Filtering extreme temperatures
    
8. Plotting
    * Fig 2 - Tile plot of seasonal temperature
    * Fig 3 - Violin plot of max, min, mean burrow temperature
    * Fig 4 - Hour of day mean temperature plot
    * Fig 5 - Buffering temperature plot
    * Visualising the 3D interaction between wind and temperature
    
9. Summary Information

10. Change Point Analysis



##______________________________________________________________
## 1. Format the metadata
##______________________________________________________________

Create one dataframe with all the metadata to be joined to the burrow temperature data of each species.

```{r}
setwd("/Users/cerren/Desktop/PhD 2021/1. Microclimate temp/Data/2021 Data/Temp data 2021")

# read plot type metadata
plotdat <- read.csv("plotdata2021.csv")

# Read logger metadata
loggers <- read.csv("Burrow_Logger.csv")

# read in the burrow feature metadata
burrows <- read.csv("burrow_features.csv")

# Select the columns that we want to join to the model_df
burrows <- burrows %>% select(Species, Burrow, Lat, Long, Width, Height, Depth, Entrance_Area, Canopy)

# Join metadata dataframes
metadata <- left_join(loggers, plotdat) %>%
                left_join(., burrows) 

# replace species abbreviations for full names
metadata$Species[metadata$Species == "ATPU"] <- "Atlantic puffin"
metadata$Species[metadata$Species == "LSSP"] <- "Leach's storm-petrel"

# specify the order of the colours
metadata$Location <- factor(metadata$Location, levels=c("Outside", "Inside"))


```

##______________________________________________________________
## 2. Format the weather data
##______________________________________________________________


```{r}

setwd("/Users/cerren/Desktop/PhD 2021/1. Microclimate temp/Data/2021 Data/Weather Data 2021/Edited")

# Read in the weather data from the two kestrel weather meters
weather1_forest <- read.csv("WEATHER_kestrel2581085.csv")
weather2_open <- read.csv("WEATHER_kestrel2581086.csv")


# Substitute the "p.m." and "a.m." because there are issues when converting 12hrs to 24hrs
weather1_forest$datetime <- gsub("p.m.", "pm", weather1_forest$datetime)
weather1_forest$datetime <- gsub("a.m.", "am", weather1_forest$datetime)

weather2_open$datetime <- gsub("p.m.", "pm", weather2_open$datetime)
weather2_open$datetime <- gsub("a.m.", "am", weather2_open$datetime)

# Convert the time from 12 hrs to 24 hrs
weather1_forest$datetime <- as.POSIXct(weather1_forest$datetime, format="%Y-%m-%d %I:%M:%S %p")
weather2_open$datetime <- as.POSIXct(weather2_open$datetime, format="%Y-%m-%d %I:%M:%S %p")

library(dplyr);library(lubridate)
# Filter the data for the correct date range
weather1_forest <- weather1_forest %>% filter(datetime <= "2021-09-25 00:00:00")
weather2_open <- weather2_open %>% filter(datetime <= "2021-09-25 00:00:00")

# Extract only the hour for making plots
weather1_forest$Time <- hour(weather1_forest$datetime) + minute(weather1_forest$datetime)/60
weather2_open$Time <- hour(weather2_open$datetime) + minute(weather2_open$datetime)/60

# Add a single date column
weather1_forest$Date <- as.Date(weather1_forest$datetime)
weather2_open$Date <- as.Date(weather2_open$datetime)

# Assign station name
weather1_forest$WeatherStation <- "Forested Plot"
weather2_open$WeatherStation <- "Open Plot"

weather1_forest <- weather1_forest %>% select(datetime, Date, Time, WeatherStation, Temperature, Wind.Speed)
weather2_open <- weather2_open %>% select(datetime, Date, Time, WeatherStation, Temperature, Wind.Speed)

# Join the two weather dataframes
weather <- rbind(weather1_forest, weather2_open)

```



##______________________________________________________________
## 3. Format the PUFFIN temperature data
##______________________________________________________________

## Combine all the files

Have to move the puffin .csv files into the working directory 

Combine all the separate burrow .csv files

```{r}

setwd("/Users/cerren/Desktop/PhD 2021/1. Microclimate temp/Data/2021 Data/Temp data 2021/ATPU edited")

# Read in all the files at once
# Make a list of all the .csv files
files <- list.files(pattern="*.csv")

# First apply read.csv, then rbind
temps <- do.call(rbind, lapply(files, function(x) read.csv(x, stringsAsFactors = FALSE)))

```

## Set up the date and time correctly

```{r}
# specify the time format
library(lubridate);library(dplyr)

# Need to specify the timezone (loggers collected data in UTC)
temps$time <- as.POSIXct(temps$time, format='%Y-%m-%d %H:%M', tz = "UTC")

# Change the timezone to Newfoundland
temps$time_NL <- with_tz(temps$time, "Canada/Newfoundland")

# The loggers did not record at the same time
# Round times to the nearest 15 minutes
temps$datetime<- round_date(temps$time_NL, "15 minutes")

# Extract only the hour for making plots
temps$Time <- hour(temps$datetime) + minute(temps$datetime)/60

# Filter the data from before the loggers were placed in the burrows 
# and after they were removed
# Also for when the kestrel weather stations were placed, so everything matches up
temps <- temps %>% filter(datetime >= "2021-07-17 17:00:00") %>% 
  filter(datetime <= "2021-08-19 00:00:00")

# add the date
temps$Date <- as.Date(temps$datetime)

```

## Join the metadata to the temperature file

Some of the loggers were not found at the end of the season. 
They were likely kicked out by the puffins as they excavated the burrows, or physically removed. 

Missing Outside logger - Burrow 6
Missing Inside logger - Burrows 2, 3, 15, 21, 27, 29
Internal logger from burrow 9 was found on the ground outside the burrow. 

NOTE: 
Burrow 36 is missing a width - because it had two burrow entrances
Burrow 21 missing depth data

```{r}

# Join metadata to temp data 
temps <- left_join(temps, metadata, by = "ID")

# Spread the dataframe so that there is an individual 
# column for internal and external temperatures
temps <- temps %>% 
  select(datetime, Date, Time, Species:Canopy, temp) %>% 
  spread(key = Location, value = temp)

# Filter out the burrows with missing internal temperature data
temps <- temps %>% 
  filter(!Burrow %in% c(2, 3, 9, 15, 21, 27, 29))

```

## Join the weather data to the burrow temperature data

```{r}

# join dataframes
temps <- left_join(temps, weather2_open)

# kestrel weather data were only recorded every 30 minutes 
# while logger data were every 15 minutes
# we will filter the logger data so it matches the kestrel data
temps <- temps %>% filter(!is.na(Temperature))

```




##______________________________________________________________
## 4. Format the PETREL temperature data
##______________________________________________________________


```{r}
setwd("/Users/cerren/Desktop/PhD 2021/1. Microclimate temp/Data/2021 Data/Temp data 2021/LSSP edited")

files <- list.files(pattern="*.csv")

# First apply read.csv, then rbind
temps_LSSP <- do.call(rbind, lapply(files, function(x) read.csv(x, stringsAsFactors = FALSE)))


```


## Set up the date and time correctly

```{r}

# Need to specify the timezone (loggers collected data in UTC)
temps_LSSP$time <- as.POSIXct(temps_LSSP$time, format='%Y-%m-%d %H:%M', tz = "UTC")

# Change the timezone to Newfoundland
temps_LSSP$time_NL <- with_tz(temps_LSSP$time, "Canada/Newfoundland")

# The loggers did not record at the same time
# Round times to the nearest 15 minutes
temps_LSSP$datetime<- round_date(temps_LSSP$time_NL, "15 minutes")

# Extract only the hour for making plots
temps_LSSP$Time <- hour(temps_LSSP$datetime) + minute(temps_LSSP$datetime)/60

# Filter the data for before the loggers were placed in the burrows 
# and after they were removed
temps_LSSP <- temps_LSSP %>% filter(datetime >= "2021-08-10 18:00:00") %>% 
  filter(datetime <= "2021-09-25 00:00:00")

# add the date
temps_LSSP$Date <- as.Date(temps_LSSP$datetime)

```

## Join the metadata to the temperature file

```{r}

# Join metadata to temp data 
temps_LSSP <- left_join(temps_LSSP, metadata, by = "ID")

# Spread the dataframe so that there is an individual 
# column for internal and external temperatures
temps_LSSP <- temps_LSSP %>% 
  select(datetime, Date, Time, Species:Canopy, temp) %>% 
  spread(key = Location, value = temp)

```

## Join the weather data to the burrow temperature data

The kestrel weather stations were placed in different plots, so we need to make sure the correct weather data is matched up to the logger data

```{r}

# Subset the logger data by the plot type that match the kestrel weather station data
open <- temps_LSSP %>% filter(Plot == "Open")
forest <- temps_LSSP %>% filter(Plot %in% c("Forest", "Near Forest"))

# Join the kestrel weather data and the temp logger data
forest <- left_join(forest, weather1_forest)
open <- left_join(open, weather2_open)

# join the data back together again
temps_LSSP <- rbind(forest, open)

# kestrel weather data were only recorded every 30 minutes 
# while logger data were every 15 minutes
# we will filter the logger data so it matches the kestrel data
temps_LSSP <- temps_LSSP %>% filter(!is.na(Temperature))

```




##______________________________________________________________
## 5. Join the formatted puffin and petrel data
##______________________________________________________________

```{r}

# Join both dataframes
ATPU_LSSP <- rbind(temps, temps_LSSP)
  
# save file 
write.csv(ATPU_LSSP, "Supplementary Material 1 - Data.csv")


## If uploading the data from the paper, start here
## Read the data in here
ATPU_LSSP <- read.csv("Supplementary Material 1 - Data.csv")

# Have to reassign the data
ATPU_LSSP$Date <- as.Date(ATPU_LSSP$Date)

```



##______________________________________________________________
## 6. Calculate the burrow temperature buffering
##______________________________________________________________

negative = inside colder than outside
positive = warmer than outside

```{r}

# Calculate the buffering capacity of the burrows
# Positive – burrow is warmer than external
# Negative – burrow is cooler than external

# Logger buffer
ATPU_LSSP$buffer_logger <- ATPU_LSSP$Inside - ATPU_LSSP$Outside

# kestrel buffer
ATPU_LSSP$buffer_kestrel <- ATPU_LSSP$Inside - ATPU_LSSP$Temperature


## Calculate the elliptical cylinder volume of the burrow for the modelling
ATPU_LSSP$volume <- pi * (ATPU_LSSP$Width/2) * (ATPU_LSSP$Height/2) * ATPU_LSSP$Depth


## Set the date as Julian Days
ATPU_LSSP$julian <- format(ATPU_LSSP$Date, "%j")

# Julian date is currently categorical. We will set as numeric
ATPU_LSSP$julian <- as.numeric(ATPU_LSSP$julian)

# Filter the dataframe for the different species
# because separate models will be run for the species
lssp <- filter(ATPU_LSSP, Species == "Leach's storm-petrel")
atpu <- filter(ATPU_LSSP, Species == "Atlantic puffin")


# save files
write.csv(lssp, "lssp.csv")
write.csv(atpu, "atpu.csv")

# set burrow as factor
lssp$Burrow <- factor(lssp$Burrow)
atpu$Burrow <- factor(atpu$Burrow)

```


##______________________________________________________________
## 7. Filtering the extreme temperatures
##______________________________________________________________

```{r}

## Identify the extreme events
## Here we define "extreme" as the 1 and 99 percentiles
quant_weather <- ATPU_LSSP %>%
  group_by(Species) %>%
  summarise(quantile1 = quantile(Temperature, c(.01), na.rm = T),
            quantile99 = quantile(Temperature, c(.99), na.rm = T),
            quantile1_logger = quantile(Outside, c(.01), na.rm = T),
            quantile99_logger = quantile(Outside, c(.99), na.rm = T))


## Filter out the extreme temperatures (Leach's)
## COLD WEATHER STATION
extreme_cold_LSSP <- filter(ATPU_LSSP, Temperature <= 6.5 & Species == "Leach's storm-petrel")
extreme_cold_LSSP$Extreme <- "Cold Extreme"
extreme_cold_LSSP$Temp <- "Station"

## Mean and SD for weather station buffering
mean(extreme_cold_LSSP$buffer_kestrel) # 7.40 deg C
sd(extreme_cold_LSSP$buffer_kestrel) #1.20

## Mean and SD for external burrow logger buffering
mean(extreme_cold_LSSP$buffer_logger) # 6.85 deg C
sd(extreme_cold_LSSP$buffer_logger) #1.33

## COLD LOGGER
extreme_cold_LSSP_logger <- filter(ATPU_LSSP, Outside <= 7.2 & Species == "Leach's storm-petrel")
extreme_cold_LSSP_logger$Extreme <- "Cold Extreme"
extreme_cold_LSSP_logger$Temp <- "Logger"




## HOT
extreme_heat_LSSP <- filter(ATPU_LSSP, Temperature >= 25.7 & Species == "Leach's storm-petrel")
extreme_heat_LSSP$Extreme <- "Heat Extreme"


## Mean and SD for weather station buffering
mean(extreme_heat_LSSP$buffer_kestrel) #-9.45 deg C
sd(extreme_heat_LSSP$buffer_kestrel) # 1.39

## Mean and SD for external burrow logger buffering
mean(extreme_heat_LSSP$buffer_logger) # -8.39 C
sd(extreme_heat_LSSP$buffer_logger) #3.47


## Filter out the extreme temperatures (Puffin)
## COLD STATION
extreme_cold_ATPU <- filter(ATPU_LSSP, Temperature <= 10 & Species == "Atlantic puffin")
extreme_cold_ATPU$Extreme <- "Cold Extreme"
extreme_cold_ATPU$Temp <- "Station"

## Mean and SD for weather station buffering
mean(extreme_cold_ATPU$buffer_kestrel, na.rm = T) # 8.049758 deg C
sd(extreme_cold_ATPU$buffer_kestrel, na.rm = T) # 1.534774

## Mean and SD for external burrow logger buffering
mean(extreme_cold_ATPU$buffer_logger, na.rm = T) # 7.75 deg C
sd(extreme_cold_ATPU$buffer_logger, na.rm = T) # 2.064

## COLD STATION
extreme_cold_ATPU_logger <- filter(ATPU_LSSP, Temperature <= 10 & Species == "Atlantic puffin")
extreme_cold_ATPU_logger$Extreme <- "Cold Extreme"
extreme_cold_ATPU_logger$Temp <- "Logger"

## HOT
extreme_heat_ATPU <- filter(ATPU_LSSP, Temperature >= 25.6 & Species == "Atlantic puffin")
extreme_heat_ATPU$Extreme <- "Heat Extreme"

## Mean and SD for weather station buffering
mean(extreme_heat_ATPU$buffer_kestrel, na.rm = T) # -5.385507 deg C
sd(extreme_heat_ATPU$buffer_kestrel, na.rm = T) #1.81329

## Mean and SD for external burrow logger buffering
mean(extreme_heat_ATPU$buffer_logger, na.rm = T) # -13 deg C
sd(extreme_heat_ATPU$buffer_logger, na.rm = T) # 5.61

## Join the dataframes
extreme <- rbind(extreme_cold_LSSP, extreme_heat_LSSP, 
                 extreme_cold_ATPU, extreme_heat_ATPU)


## Cold extremes
cold_extreme <- rbind(extreme_cold_LSSP, extreme_cold_LSSP_logger, 
                 extreme_cold_ATPU, extreme_cold_ATPU_logger)

```




##______________________________________________________________
## 8. Plotting
##______________________________________________________________

## Fig 2 - Tile plot of seasonal temperature

The following plot has been edited further to add the locations of the extreme events.

```{r}

# Using the data from the open plot weather station to create the tile plot
ggplot(weather2_open, aes(x = Date, y = Time, fill = Temperature)) +
  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), # remove the major lines
        panel.grid.minor = element_blank())+
  geom_tile(colour = "white", size = 0.15)+
  scale_fill_distiller(palette = "RdYlBu", direction = -1)+
  ylab("Time of Day (h)")+ theme(axis.title.y = element_text(vjust = 3)) +
  theme(legend.position="right")+
  guides(fill = guide_colourbar(barwidth = 0.5, barheight = 10))+
  theme(axis.title.x = element_blank())+
  labs(fill = "")


# Save
ggsave("Fig 2.pdf", 
       width = 250, height = 80, unit = "mm")

```




## Fig 3 - Violin plot of max, min, mean burrow temperature

```{r}

library(tidyr)

## Daily max, min and mean

## Summarise the daily max, min and mean for each burrow
maxmin <- ATPU_LSSP %>%
  group_by(Date, Burrow, Species) %>%
  summarise(`Daily Mean` = mean(Inside),
            `Daily Max.` = max(Inside), 
            `Daily Min.` = min(Inside)) %>%
             gather(Unit, Temperature, `Daily Mean`:`Daily Min.`) # Gather the data  

# Calculate the mean line
meanline <- maxmin %>% group_by(Species, Unit) %>%
  summarise(mean = mean(Temperature))
  

## Summarise the mean daily temperatures across all burrows so that we can order
## the main plot by decreaing mean temp
mean <- filter(maxmin, Unit =="Daily Mean") %>% 
              group_by(Species, Burrow) %>% 
              summarise(mean = mean(Temperature)) %>%
              arrange(desc(mean)) # decending by the mean order


# Create a new column of burrow names because there are issues with the ordering 
# when creating the plot because both the puffin and petrels share the same burrow numbers
mean$Burrow2 <- paste(mean$Species, mean$Burrow)

# Assign the burrows as factor to ensure correct ordering
mean$Burrow2 <- factor(mean$Burrow2, levels=mean$Burrow2)

# Join the two dataframes
maxmin <- left_join(maxmin, mean)

## Set the theme
plottheme <-  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  theme(axis.title.y = element_text(vjust = 3)) +
  theme(axis.title.x = element_text(vjust = -1))

# create the plot
ggplot()+
  geom_violin(data = maxmin, aes(x = Burrow2, 
                  y = Temperature, 
                  fill = Unit, colour = Unit))+
  scale_fill_manual(values = c("#E16E08", "#F9E07F","#89B4C7")) +
  scale_colour_manual(values = c( "#E16E08","#F9E07F","#89B4C7")) +
  xlab("Burrow") + ylab("Temperature (°C)")+
  plottheme+
  guides( alpha = FALSE, fill = FALSE, colour = FALSE)+
  facet_grid(Unit~Species, scales = "free")+
  theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"),
        strip.text.y = element_text(size = 16, color = "white", face = "bold"),
        strip.background = element_rect(fill="black"),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()
        )+
  geom_hline(data = meanline, aes(yintercept = mean), linetype = "dashed")

# Save plot
ggsave("Fig 3.pdf", 
       width = 270, height = 170, unit = "mm")

```

## Thermoneutral zone
```{r}


ATPU_LSSP <- read.csv("ATPU_LSSP.csv")


mean <-  ATPU_LSSP %>%group_by(Species, Burrow) %>% 
              summarise(mean = mean(Inside)) %>%
              arrange(desc(mean))
  
# Create a new column of burrow names because there are issues with the ordering 
# when creating the plot because both the puffin and petrels share the same burrow numbers
mean$Burrow2 <- paste(mean$Species, mean$Burrow)

# Assign the burrows as factor to ensure correct ordering
mean$Burrow2 <- factor(mean$Burrow2, levels=mean$Burrow2)  
  
# Join the two dataframes
TNZ <- left_join(ATPU_LSSP, mean)
  

## Subset for puffins
ATPU.TNZ <- TNZ %>% filter(Species == "Atlantic puffin")

## Subset for petrels
LESP.TNZ <- TNZ %>% filter(Species == "Leach's storm-petrel")


## Puffin plot
puffin.TNZ<-ggplot(data = ATPU.TNZ, aes(x = Burrow2, y = Inside))+
    annotate("rect", xmin=-Inf, xmax=Inf, ymin=13.45, ymax=35, alpha=0.2)+
   annotate("rect", xmin=-Inf, xmax=Inf, ymin=32, ymax=35, alpha=0.4)+
  geom_violin()+
 stat_summary( fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    geom = "pointrange", color = "black", size = 0.1)+
  xlab("Burrow") + ylab("Temperature (°C)")+
  plottheme+
  geom_hline(yintercept = 13.45, colour = "#414487FF", linetype = "dashed", size = 1.3)+ # mean
  geom_hline(yintercept = 10.97, colour = "#414487FF", linetype = "dotted", size = 1, alpha = 0.8)+ # 95% CI
  geom_hline(yintercept = 15.92, colour = "#414487FF", linetype = "dotted", size = 1, alpha = 0.8)+ # 95% CI
  geom_hline(yintercept = 32, colour = "#89B4C7", linetype = "dashed", size = 1.3)+ 
  geom_hline(yintercept = 35, colour = "#FCA636FF", linetype = "dashed", size = 1.3)+
  facet_wrap(~Species, scales = "free")+
    theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"),
        strip.text.y = element_text(size = 16, color = "white", face = "bold"),
        strip.background = element_rect(fill="black"),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank())



## Petrel plot
petrel.TNZ<-ggplot(data = LESP.TNZ, aes(x = Burrow2, y = Inside))+
    annotate("rect", xmin=-Inf, xmax=Inf, ymin=24, ymax=Inf, alpha=0.2)+
     annotate("rect", xmin=-Inf, xmax=Inf, ymin=32, ymax=Inf, alpha=0.4)+
  geom_violin()+
 stat_summary( fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    geom = "pointrange", color = "black", size = 0.1)+
  xlab("Burrow") + ylab("Temperature (°C)")+
  plottheme+
  geom_hline(yintercept = 24, colour = "#414487FF", linetype = "dashed", size = 1.3)+
  geom_hline(yintercept = 32, colour = "#89B4C7", linetype = "dashed", size = 1.3)+
  facet_wrap(~Species)+
    theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"),
        strip.text.y = element_text(size = 16, color = "white", face = "bold"),
        strip.background = element_rect(fill="black"),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())+
  scale_y_continuous(limits = c(9.5, 36))


library(patchwork)

puffin.TNZ/petrel.TNZ




```

## Determine proportion of time outside of TNZ

```{r}

## ATPU chick LCT = 32
## ATPU chick UCT = 35
ATPU_LSSP %>% filter(Species == "Atlantic puffin" & Inside > 32) ## No hatchlings within TNZ

## ATPU adult LCT = 13.44
no.TNZ <- ATPU_LSSP %>% filter(Species == "Atlantic puffin" & Inside < 13.44) ## 66 values
(66/35673)*100 # 0.19% (<1% of the time) across four burrows

## 95% CI = 15.92, 10.97
no.TNZ <- ATPU_LSSP %>% filter(Species == "Atlantic puffin" & Inside < 10.97) ## 0 values
no.TNZ <- ATPU_LSSP %>% filter(Species == "Atlantic puffin" & Inside < 15.92) ## 3775 values
(3775/35673)*100 # 10.58% across 19 burrows


## LESP adult LCT = 26
## LESP chick LCT = 32
ATPU_LSSP %>% filter(Species == "Leach's storm-petrel" & Inside > 26) ## No temperatures within TNZ


## Adult ATPU Time outside cold extreme
extreme_cold_ATPU %>% filter(Inside < 13.44) # 1 value
1/414



```

## Determine proportion of time as a refuge

Amount of time that 
burrow temp > outside logger 
burrow temp > weather station

```{r}

plot(LESP.TNZ$Outside, LESP.TNZ$Temperature)
plot(ATPU.TNZ$Outside, ATPU.TNZ$Temperature)


# Logger buffer
ATPU_LSSP$buffer_logger <- ATPU_LSSP$Inside - ATPU_LSSP$Outside

# kestrel buffer
ATPU_LSSP$buffer_kestrel <- ATPU_LSSP$Inside - ATPU_LSSP$Temperature

## Calculate the elliptical cylinder volume of the burrow for the modelling
ATPU_LSSP$volume <- pi * (ATPU_LSSP$Width/2) * (ATPU_LSSP$Height/2) * ATPU_LSSP$Depth



## Calculate the amount a burrow buffers 

logger <- ATPU_LSSP %>% group_by(Species, Burrow) %>% 
  mutate(Logger = ifelse(Inside > Outside, 1, 0)) %>%
  filter(Logger == 1) %>% group_by(Species, Burrow) %>% 
  summarise(mean.logger.buff = mean(buffer_logger),
            median.logger.buffer = median(buffer_logger))


station <- ATPU_LSSP %>% group_by(Species, Burrow) %>% 
  mutate(Station = ifelse(Inside > Temperature, 1,0)) %>%
  filter(Station == 1) %>% group_by(Species, Burrow) %>% 
  summarise(mean.station.buff = mean(buffer_kestrel),
            median.station.buffer = median(buffer_kestrel))

prop_refuge3 <- left_join(prop_refuge, logger) %>%
               left_join(., station)



ggplot(filter(prop_refuge3, Species == "Atlantic puffin"), 
       aes(y = median.station.buffer, x = Depth))+
  geom_point()


ggplot(filter(prop_refuge3, Species == "Leach's storm-petrel"), 
       aes(y = median.station.buffer, x = Canopy))+
  geom_point()


ggplot(filter(prop_refuge3, Species == "Leach's storm-petrel"), 
       aes(y = median.logger.buffer, x = volume))+
  geom_point()






  stat_smooth(method = "gam", formula = y ~ s(x), size = 1)

ggplot(filter(prop_refuge, Species == "Atlantic puffin"))+
  geom_point(aes(x = volume, y = prop, colour = Temp))



logger <- ATPU_LSSP %>% group_by(Species, Burrow) %>% 
  mutate(Logger = ifelse(Inside > Outside, 1, 0)) %>%
  filter(Logger == 1)

station <- ATPU_LSSP %>% group_by(Species, Burrow) %>% 
  mutate(Station = ifelse(Inside > Temperature, 1,0)) %>%
  filter(Station == 1)


ggplot(filter(station, Species == "Leach's storm-petrel"), 
       aes(y = buffer_kestrel, x = Canopy))+
  geom_point()


ggplot(filter(logger, Species == "Leach's storm-petrel"), 
       aes(y = buffer_logger, x = Canopy))+
  geom_point()



## Proportion of time in refuge
prop_refuge <- ATPU_LSSP %>% group_by(Species, Burrow) %>% 
  mutate(Logger = ifelse(Inside > Outside, 1, 0), ## Assign 1 if the burrow temperatures are greater than the outside loggers
         Station = ifelse(Inside > Temperature, 1,0)) %>% ## Assign 1 if the burrow temperatures are greater than the weather station
  select(Species, Burrow, Logger, Station) %>%
  gather(Temp, Refuge, Logger:Station) %>% # gather data
  group_by(Species, Burrow, Temp) %>%
  summarise(n=n(),
            Yes = sum(Refuge, na.rm = T),
            prop = (Yes/n)*100)
  

prop_refuge <- prop_refuge[-5,]



prop_refuge <- left_join(prop_refuge, burrows)
## Calculate the elliptical cylinder volume of the burrow for the modelling
prop_refuge$volume <- pi * (prop_refuge$Width/2) * (prop_refuge$Height/2) * prop_refuge$Depth





ggplot(filter(prop_refuge, Species == "Leach's storm-petrel"), 
       aes(x = Canopy, y = prop, colour = Temp))+
  geom_point()+
  stat_smooth(method = "gam", formula = y ~ s(x), size = 1)

ggplot(filter(prop_refuge, Species == "Atlantic puffin"))+
  geom_point(aes(x = volume, y = prop, colour = Temp))


ggplot(prop_refuge2)+
  geom_boxplot(aes(x = Species, y = prop, fill = Temp))





## Adult ATPU refuge

## Proportion of time in refuge
refuge_ad_ATPU <- ATPU_LSSP %>% filter(Species == "Atlantic puffin") %>% group_by(Burrow) %>% 
  mutate(LCT = ifelse(Inside > 13.44, 1, 0),
         Logger = ifelse(LCT == 0, ifelse(Inside > Outside, 1, 0), 1),
         Station = ifelse(LCT == 0, ifelse(Inside > Temperature, 1, 0), 1)) %>%
  select(Species, Burrow, Logger, Station) %>%
  gather(Temp, Refuge, Logger:Station) %>% # gather data
  group_by(Species, Burrow, Temp) %>%
  summarise(n=n(),
            Yes = sum(Refuge, na.rm = T),
            prop = (Yes/n)*100)

refuge_ad_ATPU$Species <- "Atlantic puffin (adult)"

prop_refuge2 <- rbind(prop_refuge, refuge_ad_ATPU)


## 95% Confindence intervals
refuge_ad_ATPU <- ATPU_LSSP %>% filter(Species == "Atlantic puffin") %>% group_by(Burrow) %>% 
  mutate(LCT = ifelse(Inside > 10.97, 1, 0),
         Logger = ifelse(LCT == 0, ifelse(Inside > Outside, 1, 0), 1),
         Station = ifelse(LCT == 0, ifelse(Inside > Temperature, 1, 0), 1)) %>%
  select(Species, Burrow, Logger, Station) %>%
  gather(Temp, Refuge, Logger:Station) %>% # gather data
  group_by(Species, Burrow, Temp) %>%
  summarise(n=n(),
            Yes = sum(Refuge, na.rm = T),
            prop = (Yes/n)*100)


refuge_ad_ATPU <- ATPU_LSSP %>% filter(Species == "Atlantic puffin") %>% group_by(Burrow) %>% 
  mutate(LCT = ifelse(Inside > 15.93, 1, 0),
         Logger = ifelse(LCT == 0, ifelse(Inside > Outside, 1, 0), 1),
         Station = ifelse(LCT == 0, ifelse(Inside > Temperature, 1, 0), 1)) %>%
  select(Species, Burrow, Logger, Station) %>%
  gather(Temp, Refuge, Logger:Station) %>% # gather data
  group_by(Species, Burrow, Temp) %>%
  summarise(n=n(),
            Yes = sum(Refuge, na.rm = T),
            prop = (Yes/n)*100)




## Cold extremes

## Proportion of time in refuge
## all 100%
cold_extreme_refuge <- cold_extreme %>% group_by(Species, Burrow) %>% 
  mutate(Logger = ifelse(Inside > Outside, 1, 0),
         Station = ifelse(Inside > Temperature, 1,0)) 




## 11/09/2021 - Hurricane Larry LESP

## Buffering of LESP
ATPU_LSSP %>% filter(Species == "Leach's storm-petrel" & Date == "2021-09-11") %>%
              summarise(mean = mean(buffer_kestrel),
                        sd = sd(buffer_kestrel))



hurricane <- ATPU_LSSP %>% filter(Species == "Leach's storm-petrel"
                                    & Date == "2021-09-11") %>% 
  group_by(Burrow) %>% 
  mutate(LCT = ifelse(Inside > 26, 1, 0),
        # Logger = ifelse(LCT == 0, ifelse(Inside > Outside, 1, 0), 1),
         Station = ifelse(LCT == 0, ifelse(Inside > Temperature, 1, 0), 1)) %>%
  select(Species, Burrow,  Station) %>%
  gather(Temp, Refuge, Station) %>% # gather data
  group_by(Species, Burrow, Temp) %>%
  summarise(n=n(),
            Yes = sum(Refuge, na.rm = T),
            prop = (Yes/n)*100)


mean(hurricane$prop)
sd(hurricane$prop)
```




## Fig 4 - Hour of day mean temperature plot

```{r}

# Gather the data 
maxmin_season <- ATPU_LSSP %>% 
                            select(Date, Time, 
                                   Species, Outside, 
                                   Inside, Temperature) %>%
                            gather(Location, Temp, Outside:Temperature)

# Give the weather station data a new name
maxmin_season$Location[maxmin_season$Location == "Temperature"] <- "Station"

# Summaries the mean, max, min and sd per hour across all burrows
# Burrow 6 is missing
maxmin_season <- maxmin_season %>% group_by(Time, Species, Location) %>%
    summarise(Mean = mean(Temp, na.rm = T),
            Max = max(Temp, na.rm = T), 
            Min = min(Temp, na.rm = T),
             sd = sd(Temp, na.rm = T))

# specify the order of the colours
maxmin_season$Location <- factor(maxmin_season$Location, levels=c("Outside", "Station", "Inside"))


# Create the plot
ggplot(data = maxmin_season, aes(x = Time, y = Mean, group = Location))+
  geom_ribbon(aes(ymin=Mean-sd, ymax=Mean+sd, fill = Location), alpha = 0.35)+
  geom_line(aes(colour = Location),  size = 1.25)+
  xlab("Time of Day (h)") + ylab("Temperature (°C)")+
  scale_x_continuous(breaks=seq(0,23,4))+
  plottheme+
  theme(legend.title = element_blank())+ 
  scale_colour_manual(values = c("#80DEEA", "#43A407","#4E342E"))+
  scale_fill_manual(values = c("#80DEEA","#43A407", "#4E342E"))+
  theme(legend.position = c(0.9, 0.8))+
  facet_wrap(~Species, scales = "free_x")+
  theme(strip.text.x = element_text(size = 16, color = "white", face = "bold"), 
        strip.background = element_rect(fill="black"))


# Save plot
ggsave("Fig 4.pdf", 
       width = 170, height = 100, unit = "mm")


```


## Fig 5 - Buffering temperature plot

```{r}

# Create the box plots representing the extremes
extremeplot <- ggplot(extreme, aes(x = Extreme, y = buffer_kestrel)) +
  geom_boxplot( aes(fill = buffer_kestrel>0))+
  scale_fill_manual(values = c("#89B4C7", "#E16E08"))+
  ylab(bquote(T[Buffer]~"(°C)"))+ xlab("Thermal Event")+
  geom_hline(yintercept = 0, linetype="dashed", size = 1)+
  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.title.x = element_text(vjust = -1))+
  theme(legend.position = "none")+
  facet_wrap(~Species, ncol = 1, scales = "free_x", strip.position = 'right')+
  theme(strip.text = element_text(size = 16, color = "white", face = "bold"), 
        strip.background = element_rect(fill="black"))


# Summarise the mean temperature and standard deviation for 
# inside and outside the burrows, and for the weather station through the season
season <- ATPU_LSSP %>%
  group_by(Species, datetime) %>%
  summarise(mean = mean(Inside), 
            sd = sd(Inside),
            meankest = mean(Temperature),
            sdkest = sd(Temperature),
            meanOut = mean(Outside, na.rm=TRUE), 
            sdOut = sd(Outside, na.rm=TRUE))


# If the datetime is not in the correct format, here is the code
season$datetime <- as.POSIXct(season$datetime, format='%Y-%m-%d %H:%M')


# Seasonal plot with the external temp logger
tempall <- ggplot(data = season, aes(x = datetime, y = mean))+
  geom_line(aes(x = datetime, y = meanOut), colour = "#80DEEA")+ # Line for external logger
  geom_ribbon(aes(ymin=meanOut-sdOut, ymax=meanOut+sdOut), # external range
              fill = "#80DEEA",alpha = 0.4)+
  geom_line(colour = "#4E342E")+ # Line for internal logger
  geom_ribbon(aes(ymin=mean-sd, ymax=mean+sd), # internal range
              fill = "#4E342E",alpha = 0.4)+
  geom_line(aes(x = datetime, y = meankest), 
            colour = "#43A407")+ # Line for weather station
  plottheme+
  ylab("Temperature (°C)")+ xlab("Date")+
  facet_wrap(~Species, scales = "free", ncol = 1)+
   theme(strip.text.x = element_blank(), 
          strip.background = element_blank())

library(patchwork)

# Layout the plots
(tempall | extremeplot) + plot_layout(widths=c(2,1))

# save the plot
ggsave("Fig 5.pdf", 
       width = 350, height = 200, unit = "mm")


```


## Visualising the 3D interaction between wind and temperature

```{r}
library(plotly)

# Petrel
plot_ly(lssp, x = ~Temperature, y = ~Wind.Speed, z = ~Inside,
               marker = list(color = ~Inside, 
                             colorscale = c('#FFE1A1', '#683531'),
                             showscale = TRUE))


# Puffin
atpu.wind <- atpu %>% filter(Wind.Speed < 30)

plot_ly(atpu.wind, x = ~Temperature, y = ~Wind.Speed, z = ~Inside,
               marker = list(color = ~Inside, 
                             colorscale = c('#FFE1A1', '#683531'),
                             showscale = TRUE))
```


## Make a map of the study plot
Code extracted from https://github.com/smcollins323/LESP-Chick-Fledging

```{r}

# Load Island polygons
Gull <- read.csv("Gull_Island_Polygon.csv")
Forest <- read.csv("Gull_Island_Forest_Polygon.csv")

#Create the map
ggplot() +
  xlab("") + ylab("") +
  coord_map()+
  geom_polygon(data = Gull, aes(x = long, y = lat), 
               colour = "black", fill = "lightgrey", linewidth = 0.05) +
  geom_polygon(data = Forest, aes(x = long, y = lat), 
               colour = "darkgrey", fill = "darkgrey")+
  geom_point(aes(x=-52.7767111, y=47.2600556), shape=8, size = 3)+ # forest weather station
  geom_point(aes(x=-52.7764417, y=47.2587861), shape=8, size = 3)+ # open weather station
  geom_point(aes(x=-52.7765700, y=47.2580000), shape=19, size = 3)+ # Puffin slope
  geom_point(aes(x=-52.7761200, y=47.2585300), shape=17, size = 3)+ # Open plot
  geom_point(aes(x=-52.7764100, y=47.2600900), shape=17, size = 3)+ # Forest plot
  geom_point(aes(x=-52.7769600, y=47.2602800), shape=17, size = 3)+ # Near Forest plot
  plottheme
  
  #scale_bar(lon = -52.7745, lat = 47.2545, distance_lon = 0.2, distance_lat = 0.1, 
  #distance_legend = 0.15, dist_unit = "km", orientation = F, legend_size = 3)

```

## Thermoneutral zones
Data: Ricklefs et al. (1986)
DAILY ENERGY EXPENDITURE BY ADULT LEACH'S STORM-PETRELS DURING THE NESTING CYCLE
Physiol. Zool. 59(6):649-660


```{r}
## Storm-petrels
## Read data from Ricklefs et al. (1986)
LESP_TNZ <- read.csv("LESP_TNZ.csv")

# Create plot
ggplot(data = LESP_TNZ)+
  annotate("rect",xmin=14,xmax=26,ymin=-Inf,ymax=Inf, alpha=0.1, fill="black")+
  #geom_vline(xintercept=14,linetype="dashed",col="blue", alpha=0.5) +
  #geom_vline(xintercept=26,linetype="dashed",col="orange", alpha=0.5) +
  geom_point(aes(x = Temperature, y = Value, colour = Response, shape = Response))+
  geom_line(aes(x = Temperature, y = Value, colour = Response))+
  plottheme+ theme(legend.position= c( 0.2, 0.85))+
  labs(colour = " ", shape = " ")



```

## Puffin TNZ

Ellis & Gabrielsen (2002) Energetics of Free-Ranging Seabirds

LCT = 43.15 – 6.58 log mass – 0.26 latitude

LCT is in degrees Celsius; mass is in g; latitude in degrees (N = 33; intercept s.e. = 3.94;
log mass coefficient s.e. = 1.43; latitude coefficient s.e. = 0.03; R2 = 0.779).


Puffin body mass (443 grams) at Gull Islands Witless Bay from:
Lowther, P. E., A. W. Diamond, S. W. Kress, G. J. Robertson, K. Russell, D. N. Nettleship, G. M. Kirwan, D. A. Christie, C. J. Sharpe, E. F. J. Garcia, and P. F. D. Boesman (2020). Atlantic Puffin (Fratercula arctica), version 1.0. In Birds of the World (S. M. Billerman, Editor). Cornell Lab of Ornithology, Ithaca, NY, USA. https://doi.org/10.2173/bow.atlpuf.01

```{r}


# Atlantic puffin

# Equation from Ellis and Gabrielsen (2002)
# LCT = 43.15 – 6.58 log mass – 0.26 latitude

43.15 - (6.58*log10(443)) - (0.26*47.267) # = 13.44724

# intercept s.e. = 3.94
# log mass coefficient s.e. = 1.43
# latitude coefficient s.e. = 0.03

## 95% confidence intervals
# Intercept
43.15-3.94*qnorm(0.975) # = 35.42774
43.15+3.94*qnorm(0.975) # = 50.87226

# Mass
6.58-1.43*qnorm(0.975) # = 3.777252
6.58+1.43*qnorm(0.975) # = 9.382748

# Latitude 
0.26-0.03*qnorm(0.975) # = 0.2012011
0.26+0.03*qnorm(0.975) # = 0.3187989

# 95% confidence equations
# LCT = 35.42774 – 3.777252 log mass – 0.2012011 latitude
# LCT = 50.87226 – 9.382748 log mass – 0.3187989 latitude

35.42774 - (3.777252*log10(443)) - (0.2012011*47.267) # = 15.92143
50.87226 - (9.382748*log10(443)) - (0.3187989*47.267) # = 10.97305






# Leach's storm-petrel

# Equation from Ellis and Gabrielsen (2002)
# LCT = 43.15 – 6.58 log mass – 0.26 latitude

43.15 - (6.58*log10(45)) - (0.26*47.267) # = 19.98244

# 95% confidence equations
# LCT = 35.42774 – 3.777252 log mass – 0.2012011 latitude
# LCT = 50.87226 – 9.382748 log mass – 0.3187989 latitude

35.42774 - (3.777252*log10(45)) - (0.2012011*47.267) # = 19.67297
50.87226 - (9.382748*log10(45)) - (0.3187989*47.267) # = 20.29192



```


##______________________________________________________________
## 9. Summary Information
##______________________________________________________________


```{r}

library(dplyr);library(tidyr)

## BURROW FEATURES
# Summarise the mean values for each of the burrow features
burrow_means <- metadata %>% group_by(Species) %>%
  summarise(width = mean(Width, na.rm =T), 
            width.sd = sd(Width, na.rm =T),
            height = mean(Height, na.rm =T),
            height.sd = sd(Height, na.rm =T),
            depth = mean(Depth, na.rm =T),
            depth.sd = sd(Depth, na.rm =T),
            enter.area = mean(Entrance_Area, na.rm =T),
            enter.area.sd = sd(Entrance_Area, na.rm =T))

# Summarise the burrow volumes
ATPU_LSSP %>% group_by(Species, Burrow) %>%
  summarise(volume = min(volume)) %>%
  summarise(vol = mean(volume, na.rm =T),
            vol.sd = sd(volume, na.rm =T))


## TEMPERATURES

## Calculate the mean variance between burrows
mean_puffin <- ATPU_LSSP %>% 
  group_by(Burrow, Species) %>%
  summarise(var = var(Inside)) 


# The mean variation between the burrows
mean_puffin %>% group_by(Species) %>%
  summarise(mean = mean(var),
            sd = sd(var))

# The mean burrow temperatures 
means<- ATPU_LSSP %>% 
  group_by(Species) %>%
  summarise(mean = mean(Inside),
            sd = sd(Inside),
            max = max(Inside),
            min = min(Inside),
            sd_out = sd(Outside, na.rm = T),
            max.out = max(Outside, na.rm = T),
            min.out = min(Outside, na.rm = T),
            mean.out = mean(Outside, na.rm = T),)


ATPU_LSSP %>% filter(Burrow !=6)%>%
  group_by(Species) %>% 
  summarise(mean = mean(Outside),
            sd = sd(Outside))

## Summarise the daily max, min and mean for each burrow
maxmin <- ATPU_LSSP %>% filter(Burrow !=6)%>%
  group_by(Date, Burrow, Species) %>%
  summarise(mean = mean(Inside),
            max = max(Inside), 
            min = min(Inside),
            max.out = max(Outside, na.rm = T),
            min.out = min(Outside, na.rm = T),           
            mean.out = mean(Outside, na.rm = T))%>%
  group_by(Burrow, Species) %>%
  summarise(mean = mean(mean),
            max = mean(max), 
            min = mean(min),
            max.out = mean(max.out, na.rm = T),
            min.out = mean(min.out, na.rm = T),           
            mean.out = mean(mean.out, na.rm = T))%>%
  group_by(Species) %>%
  summarise(mean = mean(mean),
            max = mean(max), 
            min = mean(min),
            sd.max = sd(max.out),
            sd.min =sd(min.out),
            max.out =mean(max.out, na.rm = T),
            min.out = mean(min.out, na.rm = T),           
            mean.out = mean(mean.out, na.rm = T))
  



  group_by(Species, Burrow)%>%
  summarise(mean = mean(`Daily Mean`),
            min = mean(`Daily Min.`),
            max = mean(`Daily Max.`)) %>%
  group_by(Species)%>%
  summarise(mean=mean(mean),
            sd.min=sd(min),
            sd.max=sd(max),
            min=mean(min),
            max=mean(max))




## Summarise the daily max, min and mean for each burrow
maxmin <- ATPU_LSSP %>%
  group_by(Date, Burrow, Species) %>%
  summarise(`Daily Mean` = mean(Inside),
            `Daily Max.` = max(Inside), 
            `Daily Min.` = min(Inside)) %>%
  group_by(Species, Burrow)%>%
  summarise(mean = mean(`Daily Mean`),
            min = mean(`Daily Min.`),
            max = mean(`Daily Max.`)) %>%
  group_by(Species)%>%
  summarise(mean=mean(mean),
            sd.min=sd(min),
            sd.max=sd(max),
            min=mean(min),
            max=mean(max))


# Summarise the weather data
weather %>% group_by(WeatherStation) %>%
  summarise(sd = sd(Temperature),
            mean=mean(Temperature),
            min=min(Temperature),
            max=max(Temperature))

## Overall
weather %>%
  summarise(sd = sd(Temperature),
            mean=mean(Temperature),
            min=min(Temperature),
            max=max(Temperature))


# Summarise the buffering
extreme %>%
  group_by(Species, Extreme) %>%
  summarise(mean = mean(buffer_kestrel), 
            sd = sd(buffer_kestrel),
            meanlog = mean(buffer_logger, na.rm=TRUE),
            sdlog = sd(buffer_logger, na.rm=TRUE))



# Explore the extreme temperature range to see whether 
# the extreme events are comparable for each species
extreme.summary <- extreme %>%
  group_by(Species, Extreme) %>%
  summarise(mean = mean(Temperature), 
            sd = sd(Temperature))

# ATPU 
17.9 - 9.1 # Cold extreme = 8.8 degC different from the mean burrow temp
26.1 - 17.9 # Hot extreme = 8.2 degC different from the mean burrow temp

# LESP
15.8 - 6 # Cold extreme = 9.8 degC different from the mean burrow temp
26.6 - 15.8 # Hot extreme = 10.8 degC different from the mean burrow temp


# ATPU 
16.6 - 9.1 # Cold extreme = 7.5 degC different from the mean burrow temp
26.1 - 16.6 # Hot extreme = 9.5 degC different from the mean burrow temp

# LESP
15.7 - 6 # Cold extreme = 9.7 degC different from the mean burrow temp
26.6 - 15.7 # Hot extreme = 10.9 degC different from the mean burrow temp


ATPU_LSSP %>%
  group_by(Species) %>%
  summarise(mean.temp = mean(Temperature, na.rm = T))



ggplot(extreme, aes(x = Extreme, y = Temperature)) +
  geom_boxplot( aes(fill = buffer_kestrel>0))+
  scale_fill_manual(values = c( "#E16E08", "#89B4C7"))+
  ylab("Air Temperature (°C)")+ xlab("Thermal Event")+
  theme_bw(base_size = 15)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.title.x = element_text(vjust = -1))+
  theme(legend.position = "none")+
  facet_wrap(~Species, scales = "free_y")+
  geom_hline(yintercept = 16.6, linetype = "dashed")+
  geom_hline(yintercept = 15.8, linetype = "dashed")+
  theme(strip.text = element_text(size = 16, color = "white", face = "bold"), 
        strip.background = element_rect(fill="black"))


```



##______________________________________________________________
## 10. Change Point Analysis
##______________________________________________________________

Run a change point analysis with package `changepoint` which finds changes in mean of the internal burrow temperature to identify whether there was a significant change when the extreme seasonal events hit. 


## Puffins

Use the  pruned exact linear time (PELT) method - "The PELT algorithm
proposed by Killick et al. (2012a) is similar to that of the segment neighborhood algorithm
in that it provides an exact segmentation. However, due to the construction of the PELT algorithm, it can be shown to be more computationally efficient. Changepoints are spread throughout the data rather than confined to one portion."

Visualise the trend with a subset of the data. No penalties appear to identify too many changepoints. We will identify the appropriate amount of penalties with an elbow plot.

Using this tutorial to determine the correct number of penalties:
http://rstudio-pubs-static.s3.amazonaws.com/269908_838de132ef2a4d07b58d03ffa088c3ed.html

```{r}
library(changepoint)

# Change value to check multiple burrows
x <- filter(atpu, Burrow == "11")
x1 <- cpt.mean(x$Inside, method = "PELT")
plot(x1)


# running through a sequence of different penalty parameters
cptfn <- function(data, pen) {
  ans <- cpt.mean(data, test.stat="Normal", method = "PELT", penalty = "Manual", pen.value = pen) 
  length(cpts(ans)) +1
}
 

# run cptfn for the signal with a known change point
pen.vals <- seq(0, 40,.2)

# Apply through all of the penalties
elbowplotData <- unlist(lapply(pen.vals, function(p) 
                  cptfn(data = x$Inside, pen = p)))

# Visualise the elbow plot
plot(pen.vals,elbowplotData, 
     xlab = "PELT penalty parameter",
     ylab = " ",
     main = " ")


```

Apply manual penalty of 40 across all burrows.

```{r}
#create an empty list
mylist <- list() 


# Create a loop to extract the change points for each burrow

for(i in unique(atpu$Burrow)){
  
# Filter the data to select 
x <- filter(atpu, Burrow == i) 

# Identify the change points
cpt <- cpts(cpt.mean(x$Inside, method = "PELT", penalty = "Manual", pen.value = "40"))

# Place them all in a list
mylist[i] <- list(as.data.frame(list("Burrow" = x[1,"Burrow"],
                         "Points" = cpt,
                         "Date" = x$Date[cpt])))

}

## Reduce the lists down
change <- Reduce(rbind, mylist) 

# Identify how many of the burrows fall within the range of the heat extremes
# 04/08/2021 - 08/08/2021 - heat extreme 1 range
# 14/08/2021 - heat extreme 2 beginning

# Heat extreme 1 = 23/23 burrows (100%)  
cptsummary <- change %>% filter(Date >= "2021-08-04") %>% 
  filter(Date <= "2021-08-08") %>% distinct(Burrow, .keep_all = TRUE)

# Heat extreme 2 = 23/23 burrows (100%)
cptsummary <- change %>% filter(Date >= "2021-08-14") %>% 
  distinct(Burrow, .keep_all = TRUE)


```

## Petrels

```{r}
# Change value to check multiple burrows
x <- filter(lssp, Burrow == "130")
x1 <- cpt.mean(x$Inside, method = "PELT")
plot(x1)


# running through a sequence of different penalty parameters
cptfn <- function(data, pen) {
  ans <- cpt.mean(data, test.stat="Normal", method = "PELT", penalty = "Manual", pen.value = pen) 
  length(cpts(ans)) +1
}
 

# run cptfn for the signal with a known change point
pen.vals <- seq(0, 40,.2)

# Apply through all of the penalties
elbowplotData <- unlist(lapply(pen.vals, function(p) 
                  cptfn(data = x$Inside, pen = p)))

# Visualise the elbow plot
plot(pen.vals,elbowplotData, 
     xlab = "PELT penalty parameter",
     ylab = " ",
     main = " ")


```

Apply manual penalty of 15 across all burrows.

```{r}
#create an empty list
mylist <- list() 


# Create a loop to extract the change points for each burrow

for(i in unique(lssp$Burrow)){
  
# Filter the data to select 
x <- filter(lssp, Burrow == i) 

# Identify the change points
cpt <- cpts(cpt.mean(x$Inside, method = "PELT",  penalty = "Manual", pen.value = "15"))

# Place them all in a list
mylist[i] <- list(as.data.frame(list("Burrow" = x[1,"Burrow"],
                         "Points" = cpt,
                         "Date" = x$Date[cpt])))

}

## Reduce the lists down
change <- Reduce(rbind, mylist) 

# Identify how many of the burrows fall within the range of the heat extremes
# 14/08/2021 - 19/08/2021 - heat extreme 2 range
# 11/09/2021 - Hurricane Larry
# 20/09/2021 - 21/09/2021 - Cyclone Odette range

# Heat extreme 2 = 29/30 burrows (97%)
cptsummary <- change %>%  filter(Date >= "2021-08-14") %>% 
  filter(Date <= "2021-08-19") %>% distinct(Burrow, .keep_all = TRUE)

# Larry = 5/30 (17%)
cptsummary <- change %>% filter(Date == "2021-09-11") %>% 
  distinct(Burrow, .keep_all = TRUE)

# Odette = 27/30 burrows (90%)
cptsummary <- change %>% filter(Date >= "2021-09-20") %>% 
  distinct(Burrow, .keep_all = TRUE)

```

